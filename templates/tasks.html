<!-- templates/tasks.html - å®Œæ•´ç‰ˆæœ¬ï¼ˆåŒ…å«å­¦ä¹ è®¡æ—¶å™¨å’Œç»Ÿè®¡å›¾è¡¨ï¼‰ -->
{% extends "base.html" %}

{% block title %}ä»»åŠ¡ç®¡ç† - CampusPulse{% endblock %}

{% block extra_css %}
<style>
    /* ä»»åŠ¡ç®¡ç†ä¸“å±æ ·å¼ */
    .task-filters {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
        border-radius: var(--radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(99, 102, 241, 0.1);
    }
    
    .task-card {
        border-left: 4px solid transparent;
        transition: var(--transition);
        margin-bottom: 1rem;
    }
    
    .task-card.priority-1 {
        border-left-color: #ef4444;
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, transparent 100%);
    }
    
    .task-card.priority-2 {
        border-left-color: #f59e0b;
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, transparent 100%);
    }
    
    .task-card.priority-3 {
        border-left-color: #64748b;
        background: linear-gradient(135deg, rgba(100, 116, 139, 0.05) 0%, transparent 100%);
    }
    
    .task-card.completed {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%);
        border-left-color: #10b981;
        opacity: 0.8;
    }
    
    .task-card.completed .task-title {
        text-decoration: line-through;
        color: var(--gray);
    }
    
    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }
    
    .task-title {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .task-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 0.75rem;
    }
    
    .task-date {
        color: var(--gray);
        font-size: 0.875rem;
    }
    
    .task-actions {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .task-card:hover .task-actions {
        opacity: 1;
    }
    
    .empty-tasks {
        padding: 4rem 2rem;
        text-align: center;
        color: var(--gray);
    }
    
    .empty-tasks i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    
    .stats-card-small {
        padding: 1rem;
        border-radius: var(--radius);
        background: white;
        box-shadow: var(--shadow-sm);
        text-align: center;
        transition: var(--transition);
    }
    
    .stats-card-small:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }
    
    .task-checkbox {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 2px solid var(--gray-light);
        cursor: pointer;
        transition: var(--transition);
    }
    
    .task-checkbox:checked {
        background-color: var(--primary);
        border-color: var(--primary);
    }
    
    .batch-actions {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        border-radius: var(--radius);
        padding: 1rem;
        margin-top: 1rem;
        display: none;
    }
    
    .due-date-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }
    
    .due-date-soon {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    .due-date-normal {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .due-date-far {
        background: rgba(100, 116, 139, 0.1);
        color: #64748b;
        border: 1px solid rgba(100, 116, 139, 0.2);
    }
    
    /* å­¦ä¹ è®¡æ—¶å™¨æ ·å¼ */
    .study-timer-container {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        border-radius: var(--radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow);
    }
    
    .timer-display {
        font-family: 'Courier New', monospace;
        font-size: 3rem;
        font-weight: bold;
        text-align: center;
        margin: 1rem 0;
        letter-spacing: 2px;
    }
    
    .timer-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
    }
    
    .timer-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .timer-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .timer-btn.start {
        background: #10b981;
        color: white;
    }
    
    .timer-btn.pause {
        background: #f59e0b;
        color: white;
    }
    
    .timer-btn.stop {
        background: #ef4444;
        color: white;
    }
    
    .timer-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }
    
    .study-session-modal .modal-dialog {
        max-width: 500px;
    }
    
    .focus-stars {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        margin: 1rem 0;
    }
    
    .focus-star {
        font-size: 1.5rem;
        color: #e2e8f0;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .focus-star.selected {
        color: #fbbf24;
        transform: scale(1.2);
    }
    
    .focus-star:hover {
        color: #fbbf24;
    }
    
    /* å­¦ä¹ ç»Ÿè®¡å›¾è¡¨æ ·å¼ */
    .stats-chart-container {
        background: white;
        border-radius: var(--radius);
        padding: 1.5rem;
        box-shadow: var(--shadow-sm);
        margin-top: 1.5rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: #f8fafc;
        border-radius: var(--radius);
        padding: 1.25rem;
        text-align: center;
        border-left: 4px solid #6366f1;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #64748b;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 1rem 0;
    }
    
    /* å­¦ä¹ å†å²æ ·å¼ */
    .session-history {
        margin-top: 2rem;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .session-item {
        background: white;
        border-radius: var(--radius);
        padding: 1rem;
        margin-bottom: 0.75rem;
        border-left: 4px solid #6366f1;
        transition: var(--transition);
    }
    
    .session-item:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow-sm);
    }
    
    .session-duration {
        font-size: 1.25rem;
        font-weight: bold;
        color: #6366f1;
    }
    
    .session-date {
        color: #64748b;
        font-size: 0.875rem;
    }
    
    .session-notes {
        margin-top: 0.5rem;
        color: #475569;
        font-style: italic;
    }
    
    .empty-stats {
        text-align: center;
        padding: 3rem 2rem;
        color: #64748b;
    }
    
    .empty-stats i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    
    /* è‡ªå®šä¹‰ä»»åŠ¡åæ ·å¼ */
    .custom-task-input {
        margin-top: 1rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: var(--radius);
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .custom-task-input .input-group-text {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
    }
    
    .custom-task-input .form-control {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .task-name-display {
        background: rgba(59, 130, 246, 0.1);
        border-radius: var(--radius);
        padding: 0.75rem;
        margin-bottom: 1rem;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .task-name-display .task-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #3b82f6;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
    }
    
    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 768px) {
        .timer-display {
            font-size: 2.5rem;
        }
        
        .timer-controls {
            flex-direction: column;
            align-items: center;
        }
        
        .timer-btn {
            width: 100%;
            justify-content: center;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- é¡µé¢æ ‡é¢˜å’Œæ“ä½œ -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-2">
                    <i class="bi bi-list-task text-primary me-2"></i>ä»»åŠ¡ç®¡ç†
                </h1>
                <p class="text-muted mb-0">ç®¡ç†ä½ çš„å­¦ä¹ ä»»åŠ¡ï¼Œæé«˜å­¦ä¹ æ•ˆç‡</p>
            </div>
            <button class="btn btn-primary hover-lift" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                <i class="bi bi-plus-lg me-1"></i>æ·»åŠ æ–°ä»»åŠ¡
            </button>
        </div>
    </div>

    <!-- å­¦ä¹ è®¡æ—¶å™¨å’Œç»Ÿè®¡ -->
    <div class="col-12">
        <!-- å­¦ä¹ è®¡æ—¶å™¨ -->
        <div class="study-timer-container fade-in">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-2">
                        <i class="bi bi-clock-history me-2"></i>å­¦ä¹ è®¡æ—¶å™¨
                    </h4>
                    <p class="opacity-75 mb-0">
                        é€‰æ‹©ä»»åŠ¡æˆ–è‡ªå®šä¹‰ä»»åŠ¡åå¼€å§‹è®¡æ—¶ï¼Œè®°å½•ä½ çš„å­¦ä¹ æ—¶é•¿
                    </p>
                    
                    <!-- å½“å‰ä»»åŠ¡æ˜¾ç¤º -->
                    <div class="task-name-display d-flex align-items-center" id="currentTaskDisplay" style="display: none;">
                        <div class="task-icon">
                            <i class="bi bi-journal-text"></i>
                        </div>
                        <div>
                            <h6 class="mb-1 text-white" id="currentTaskName">å½“å‰ä»»åŠ¡</h6>
                            <small class="text-white opacity-75">æ­£åœ¨å­¦ä¹ ...</small>
                        </div>
                    </div>
                    
                    <!-- ä»»åŠ¡é€‰æ‹©å™¨ -->
                    <div class="mt-3">
                        <label class="form-label text-white">é€‰æ‹©ä»»åŠ¡</label>
                        <select class="form-select" id="taskSelector">
                            <option value="">ä¸å…³è”ä»»åŠ¡ï¼ˆè‡ªç”±å­¦ä¹ ï¼‰</option>
                            {% for task in tasks %}
                            {% if task.status != 'completed' %}
                            <option value="{{ task.id }}" data-title="{{ task.title }}">
                                {{ task.title }} 
                                {% if task.priority == 1 %}
                                <span class="badge bg-danger">é«˜</span>
                                {% elif task.priority == 2 %}
                                <span class="badge bg-warning">ä¸­</span>
                                {% else %}
                                <span class="badge bg-secondary">ä½</span>
                                {% endif %}
                            </option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- è‡ªå®šä¹‰ä»»åŠ¡å -->
                    <div class="custom-task-input">
                        <label class="form-label text-white">æˆ–è‡ªå®šä¹‰ä»»åŠ¡å</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-pencil"></i>
                            </span>
                            <input type="text" class="form-control" id="customTaskName" 
                                   placeholder="ä¾‹å¦‚ï¼šå¤ä¹ æ•°å­¦ç¬¬ä¸€ç« ã€é˜…è¯»è®ºæ–‡...">
                            <button class="btn btn-outline-light" type="button" id="useCustomTask">
                                ä½¿ç”¨
                            </button>
                        </div>
                        <small class="text-white opacity-75">è‡ªå®šä¹‰ä»»åŠ¡åå°†ç”¨äºå­¦ä¹ ç»Ÿè®¡</small>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="timer-display" id="timerDisplay">00:00:00</div>
                    <div class="timer-controls">
                        <button class="timer-btn start" id="startTimerBtn">
                            <i class="bi bi-play-circle"></i>å¼€å§‹
                        </button>
                        <button class="timer-btn pause" id="pauseTimerBtn" disabled>
                            <i class="bi bi-pause-circle"></i>æš‚åœ
                        </button>
                        <button class="timer-btn stop" id="stopTimerBtn" disabled>
                            <i class="bi bi-stop-circle"></i>ç»“æŸ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å­¦ä¹ ç»Ÿè®¡å›¾è¡¨ -->
    <div class="col-12">
        <div class="stats-chart-container fade-in" style="animation-delay: 0.1s">
            <h5 class="mb-3">
                <i class="bi bi-bar-chart text-primary me-2"></i>å­¦ä¹ ç»Ÿè®¡
                <button class="btn btn-sm btn-outline-primary ms-2 hover-lift" id="refreshStatsBtn">
                    <i class="bi bi-arrow-clockwise"></i>åˆ·æ–°
                </button>
            </h5>
            
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid" id="statsCards">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
            
            <!-- é¥¼çŠ¶å›¾ -->
            <div class="chart-container">
                <canvas id="studyPieChart"></canvas>
            </div>
            
            <!-- å­¦ä¹ è¶‹åŠ¿ -->
            <div class="mt-4">
                <h6 class="mb-3">
                    <i class="bi bi-graph-up text-primary me-2"></i>æœ€è¿‘7å¤©å­¦ä¹ è¶‹åŠ¿
                </h6>
                <div class="chart-container">
                    <canvas id="studyTrendChart"></canvas>
                </div>
            </div>
            
            <!-- å­¦ä¹ å†å² -->
            <div class="session-history" id="sessionHistory">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- åŸæœ‰çš„ç»Ÿè®¡å¡ç‰‡åŒºåŸŸä¿æŒä¸å˜ -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card-small">
            <div class="text-primary fw-bold fs-4 mb-1">{{ tasks|length }}</div>
            <div class="text-muted small">æ€»ä»»åŠ¡æ•°</div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card-small">
            <div class="text-success fw-bold fs-4 mb-1">
                {{ tasks|selectattr('status', 'equalto', 'completed')|list|length }}
            </div>
            <div class="text-muted small">å·²å®Œæˆ</div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card-small">
            <div class="text-warning fw-bold fs-4 mb-1">
                {{ tasks|selectattr('status', 'equalto', 'pending')|list|length }}
            </div>
            <div class="text-muted small">è¿›è¡Œä¸­</div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card-small">
            <div class="text-danger fw-bold fs-4 mb-1">
                {{ tasks|selectattr('priority', 'equalto', 1)|list|length }}
            </div>
            <div class="text-muted small">é«˜ä¼˜å…ˆçº§</div>
        </div>
    </div>

    <!-- ç­›é€‰åŒºåŸŸ -->
    <div class="col-12">
        <div class="task-filters">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-funnel me-1"></i>çŠ¶æ€ç­›é€‰
                    </label>
                    <select class="form-select" id="filterStatus">
                        <option value="all">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="pending">å¾…å®Œæˆ</option>
                        <option value="completed">å·²å®Œæˆ</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-flag me-1"></i>ä¼˜å…ˆçº§
                    </label>
                    <select class="form-select" id="filterPriority">
                        <option value="all">æ‰€æœ‰ä¼˜å…ˆçº§</option>
                        <option value="1">é«˜ä¼˜å…ˆçº§</option>
                        <option value="2">ä¸­ä¼˜å…ˆçº§</option>
                        <option value="3">ä½ä¼˜å…ˆçº§</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-calendar me-1"></i>æ’åºæ–¹å¼
                    </label>
                    <select class="form-select" id="sortTasks">
                        <option value="created_desc">æœ€æ–°åˆ›å»º</option>
                        <option value="created_asc">æœ€æ—©åˆ›å»º</option>
                        <option value="priority_asc">ä¼˜å…ˆçº§(é«˜â†’ä½)</option>
                        <option value="priority_desc">ä¼˜å…ˆçº§(ä½â†’é«˜)</option>
                    </select>
                </div>
                
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-outline-secondary w-100 hover-lift" id="clearFilters">
                        <i class="bi bi-x-circle me-1"></i>æ¸…é™¤ç­›é€‰
                    </button>
                </div>
            </div>
            
            <!-- æ‰¹é‡æ“ä½œ -->
            <div class="batch-actions" id="batchActions">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-semibold text-primary">
                            <i class="bi bi-check2-square me-1"></i>
                            å·²é€‰æ‹© <span id="selectedCount">0</span> ä¸ªä»»åŠ¡
                        </span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm hover-lift" id="batchCompleteBtn">
                            <i class="bi bi-check-all me-1"></i>æ‰¹é‡å®Œæˆ
                        </button>
                        <button class="btn btn-danger btn-sm hover-lift ms-2" id="batchDeleteBtn">
                            <i class="bi bi-trash me-1"></i>æ‰¹é‡åˆ é™¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡åˆ—è¡¨ -->
    <div class="col-12">
        {% if tasks %}
        <div class="row g-3" id="tasksContainer">
            {% for task in tasks %}
            <div class="col-lg-6 task-item" 
                 data-id="{{ task.id }}"
                 data-status="{{ task.status }}"
                 data-priority="{{ task.priority }}"
                 data-created="{{ task.created_at.timestamp() }}">
                <div class="task-card card hover-lift priority-{{ task.priority }} {% if task.status == 'completed' %}completed{% endif %}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="form-check">
                                    <input class="form-check-input task-checkbox" type="checkbox" 
                                           value="{{ task.id }}" id="taskCheck{{ task.id }}">
                                </div>
                                
                                <div class="task-title">
                                    {{ task.title }}
                                    {% if task.priority == 1 %}
                                        <span class="badge bg-danger">é«˜</span>
                                    {% elif task.priority == 2 %}
                                        <span class="badge bg-warning">ä¸­</span>
                                    {% else %}
                                        <span class="badge bg-secondary">ä½</span>
                                    {% endif %}
                                    
                                    {% if task.status == 'completed' %}
                                        <span class="badge bg-success">å·²å®Œæˆ</span>
                                    {% endif %}
                                </div>
                                
                                {% if task.description %}
                                <p class="text-muted mb-2 small">{{ task.description }}</p>
                                {% endif %}
                                
                                <div class="task-meta">
                                    <span class="task-date">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        {{ task.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    </span>
                                    
                                    {% if task.due_date %}
                                    {% set days_left = (task.due_date.date() - now.date()).days %}
                                    <span class="due-date-badge {% if days_left < 0 %}due-date-soon{% elif days_left < 3 %}due-date-soon{% elif days_left < 7 %}due-date-normal{% else %}due-date-far{% endif %}">
                                        <i class="bi bi-clock me-1"></i>
                                        æˆªæ­¢: {{ task.due_date.strftime('%m-%d') }}
                                        {% if days_left >= 0 %}
                                            ({{ days_left }}å¤©)
                                        {% else %}
                                            (å·²è¿‡æœŸ)
                                        {% endif %}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="task-actions">
                                <div class="btn-group btn-group-sm">
                                    {% if task.status != 'completed' %}
                                    <button class="btn btn-outline-success complete-task-btn hover-lift" 
                                            data-task-id="{{ task.id }}"
                                            data-task-title="{{ task.title }}"
                                            title="æ ‡è®°å®Œæˆ">
                                        <i class="bi bi-check"></i>
                                    </button>
                                    {% endif %}
                                    
                                    <button class="btn btn-outline-primary edit-task-btn hover-lift"
                                            data-task-id="{{ task.id }}"
                                            data-task-title="{{ task.title }}"
                                            data-task-desc="{{ task.description or '' }}"
                                            data-task-priority="{{ task.priority }}"
                                            data-task-due-date="{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else '' }}"
                                            title="ç¼–è¾‘">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    
                                    <button class="btn btn-outline-danger delete-task-btn hover-lift"
                                            data-task-id="{{ task.id }}"
                                            data-task-title="{{ task.title }}"
                                            title="åˆ é™¤">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- å…¨é€‰æ“ä½œ -->
        <div class="mt-4 d-flex justify-content-between align-items-center">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="selectAllTasks">
                <label class="form-check-label text-muted" for="selectAllTasks">
                    å…¨é€‰å½“å‰é¡µé¢ä»»åŠ¡
                </label>
            </div>
            
            <div class="text-muted small">
                å…± {{ tasks|length }} ä¸ªä»»åŠ¡ï¼Œ{{ tasks|selectattr('status', 'equalto', 'completed')|list|length }} ä¸ªå·²å®Œæˆ
            </div>
        </div>
        
        {% else %}
        <div class="empty-tasks">
            <i class="bi bi-inbox"></i>
            <h5 class="mb-2">è¿˜æ²¡æœ‰ä»»ä½•ä»»åŠ¡</h5>
            <p class="text-muted mb-3">åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œå¼€å§‹é«˜æ•ˆå­¦ä¹ å§ï¼</p>
            <button class="btn btn-primary hover-lift" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                <i class="bi bi-plus-lg me-1"></i>åˆ›å»ºç¬¬ä¸€ä¸ªä»»åŠ¡
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- æ·»åŠ ä»»åŠ¡æ¨¡æ€æ¡† -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle text-primary me-2"></i>æ·»åŠ æ–°ä»»åŠ¡
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_task') }}" method="POST" id="addTaskForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">ä»»åŠ¡æ ‡é¢˜ *</label>
                        <input type="text" class="form-control" name="title" required 
                               placeholder="ä¾‹å¦‚ï¼šå®ŒæˆPythonå®éªŒæŠ¥å‘Š" id="taskTitleInput">
                        <div class="form-text">ç®€æ´æ˜äº†åœ°æè¿°ä»»åŠ¡</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                        <textarea class="form-control" name="description" rows="3" 
                                  placeholder="è¯¦ç»†æè¿°ä»»åŠ¡å†…å®¹ã€è¦æ±‚æˆ–æ³¨æ„äº‹é¡¹..."
                                  id="taskDescInput"></textarea>
                        <div class="form-text">0/500 å­—</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">ä¼˜å…ˆçº§</label>
                            <select class="form-select" name="priority" id="taskPrioritySelect">
                                <option value="1">ğŸ”¥ é«˜ä¼˜å…ˆçº§</option>
                                <option value="2" selected>âš¡ ä¸­ä¼˜å…ˆçº§</option>
                                <option value="3">ğŸ“‹ ä½ä¼˜å…ˆçº§</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">æˆªæ­¢æ—¥æœŸï¼ˆå¯é€‰ï¼‰</label>
                            <input type="date" class="form-control" name="due_date" 
                                   id="taskDueDateInput">
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary hover-lift" data-bs-dismiss="modal">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="btn btn-primary hover-lift" id="submitTaskBtn">
                        æ·»åŠ ä»»åŠ¡
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡† -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title">
                    <i class="bi bi-pencil text-primary me-2"></i>ç¼–è¾‘ä»»åŠ¡
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId" name="task_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">ä»»åŠ¡æ ‡é¢˜ *</label>
                        <input type="text" class="form-control" id="editTaskTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">ä»»åŠ¡æè¿°</label>
                        <textarea class="form-control" id="editTaskDesc" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">ä¼˜å…ˆçº§</label>
                            <select class="form-select" id="editTaskPriority">
                                <option value="1">ğŸ”¥ é«˜ä¼˜å…ˆçº§</option>
                                <option value="2">âš¡ ä¸­ä¼˜å…ˆçº§</option>
                                <option value="3">ğŸ“‹ ä½ä¼˜å…ˆçº§</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">æˆªæ­¢æ—¥æœŸ</label>
                            <input type="date" class="form-control" id="editTaskDueDate">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">çŠ¶æ€</label>
                        <select class="form-select" id="editTaskStatus">
                            <option value="pending">è¿›è¡Œä¸­</option>
                            <option value="completed">å·²å®Œæˆ</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary hover-lift" data-bs-dismiss="modal">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="btn btn-primary hover-lift">
                        ä¿å­˜æ›´æ”¹
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- å­¦ä¹ ç»“æŸæ¨¡æ€æ¡† -->
<div class="modal fade study-session-modal" id="studyEndModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle text-success me-2"></i>å­¦ä¹ å®Œæˆï¼
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="fs-1 text-success mb-2" id="sessionDurationDisplay">0åˆ†é’Ÿ</div>
                    <p class="text-muted">æœ¬æ¬¡å­¦ä¹ æ—¶é•¿</p>
                    <div class="alert alert-info">
                        <i class="bi bi-journal-text me-2"></i>
                        <strong>å­¦ä¹ ä»»åŠ¡ï¼š</strong>
                        <span id="sessionTaskName">è‡ªç”±å­¦ä¹ </span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-semibold">ä¸“æ³¨åº¦è¯„åˆ†</label>
                    <div class="focus-stars" id="focusStars">
                        <span class="focus-star" data-score="1">â˜†</span>
                        <span class="focus-star" data-score="2">â˜†</span>
                        <span class="focus-star" data-score="3">â˜†</span>
                        <span class="focus-star" data-score="4">â˜†</span>
                        <span class="focus-star" data-score="5">â˜†</span>
                    </div>
                    <input type="hidden" id="focusScore" value="3">
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-semibold">å­¦ä¹ å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea class="form-control" id="sessionNotes" rows="3" 
                              placeholder="è®°å½•æœ¬æ¬¡å­¦ä¹ çš„æ”¶è·ã€éš¾ç‚¹æˆ–æƒ³æ³•..."></textarea>
                    <small class="text-muted">å¤‡æ³¨å°†ç”¨äºå­¦ä¹ ç»Ÿè®¡</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary hover-lift" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary hover-lift" id="saveSessionBtn">
                    <i class="bi bi-save me-1"></i>ä¿å­˜å­¦ä¹ è®°å½•
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // å­¦ä¹ è®¡æ—¶å™¨å˜é‡
    let studyTimerInterval = null;
    let timerSeconds = 0;
    let isTimerRunning = false;
    let activeSessionId = null;
    let selectedTaskId = null;
    let selectedTaskName = null;
    let customTaskName = null;
    let usingCustomTask = false;
    
    const timerDisplay = $('#timerDisplay');
    const startBtn = $('#startTimerBtn');
    const pauseBtn = $('#pauseTimerBtn');
    const stopBtn = $('#stopTimerBtn');
    const taskSelector = $('#taskSelector');
    const customTaskNameInput = $('#customTaskName');
    const useCustomTaskBtn = $('#useCustomTask');
    const currentTaskDisplay = $('#currentTaskDisplay');
    const currentTaskName = $('#currentTaskName');
    const statsCards = $('#statsCards');
    const sessionHistory = $('#sessionHistory');
    const refreshStatsBtn = $('#refreshStatsBtn');
    
    // Chart.js å®ä¾‹
    let pieChart = null;
    let trendChart = null;
    
    // ==================== åˆå§‹åŒ–å‡½æ•° ====================
    async function initializeStudyTimer() {
        console.log("åˆå§‹åŒ–å­¦ä¹ è®¡æ—¶å™¨...");
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„å­¦ä¹ ä¼šè¯
        await checkActiveSession();
        
        // åŠ è½½å­¦ä¹ ç»Ÿè®¡
        await loadStudyStatistics();
        
        // åŠ è½½å­¦ä¹ å†å²
        await loadSessionHistory();
        
        // åˆå§‹åŒ–ä¸“æ³¨åº¦è¯„åˆ†
        $('.focus-star').eq(2).addClass('selected'); // é»˜è®¤3æ˜Ÿ
        
        // è®¾ç½®ä¸“æ³¨åº¦è¯„åˆ†ç‚¹å‡»äº‹ä»¶
        $('.focus-star').click(function() {
            const score = $(this).data('score');
            $('#focusScore').val(score);
            
            $('.focus-star').removeClass('selected');
            $('.focus-star').each(function() {
                if ($(this).data('score') <= score) {
                    $(this).addClass('selected');
                }
            });
        });
        
        console.log("å­¦ä¹ è®¡æ—¶å™¨åˆå§‹åŒ–å®Œæˆ");
    }
    
    // ==================== è®¡æ—¶å™¨æ ¸å¿ƒåŠŸèƒ½ ====================
    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    function formatTime(seconds) {
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„å­¦ä¹ ä¼šè¯
    async function checkActiveSession() {
        try {
            console.log("æ£€æŸ¥æ´»è·ƒçš„å­¦ä¹ ä¼šè¯...");
            const response = await fetch('/api/study/active');
            const data = await response.json();
            
            if (data.success && data.active) {
                console.log("æ‰¾åˆ°æ´»è·ƒä¼šè¯:", data);
                activeSessionId = data.session_id;
                selectedTaskId = data.task_id;
                selectedTaskName = data.task_name;
                
                // è®¡ç®—å·²ç”¨æ—¶é•¿
                const startTime = new Date(data.start_time);
                const now = new Date();
                timerSeconds = Math.floor((now - startTime) / 1000);
                
                // æ›´æ–°æ˜¾ç¤º
                timerDisplay.text(formatTime(timerSeconds));
                updateCurrentTaskDisplay(selectedTaskName);
                
                // è®¾ç½®ä»»åŠ¡é€‰æ‹©å™¨
                if (selectedTaskId) {
                    taskSelector.val(selectedTaskId);
                } else if (selectedTaskName && selectedTaskName !== "è‡ªç”±å­¦ä¹ ") {
                    // å¦‚æœæ˜¯è‡ªå®šä¹‰ä»»åŠ¡å
                    customTaskName = selectedTaskName;
                    customTaskNameInput.val(selectedTaskName);
                    usingCustomTask = true;
                }
                
                // å¼€å§‹è®¡æ—¶
                startTimer();
                
                showToast('æ£€æµ‹åˆ°æœªç»“æŸçš„å­¦ä¹ ä¼šè¯ï¼Œå·²è‡ªåŠ¨æ¢å¤', 'info');
            } else {
                console.log("æ²¡æœ‰æ´»è·ƒä¼šè¯");
            }
        } catch (error) {
            console.error('æ£€æŸ¥æ´»è·ƒä¼šè¯å¤±è´¥:', error);
        }
    }
    
    // æ›´æ–°å½“å‰ä»»åŠ¡æ˜¾ç¤º
    function updateCurrentTaskDisplay(taskName) {
        if (taskName && taskName !== "è‡ªç”±å­¦ä¹ ") {
            currentTaskName.text(taskName);
            currentTaskDisplay.show();
        } else {
            currentTaskDisplay.hide();
        }
    }
    
    // å¼€å§‹è®¡æ—¶
    function startTimer() {
        if (isTimerRunning) return;
        
        isTimerRunning = true;
        startBtn.prop('disabled', true);
        pauseBtn.prop('disabled', false);
        stopBtn.prop('disabled', false);
        
        studyTimerInterval = setInterval(() => {
            timerSeconds++;
            timerDisplay.text(formatTime(timerSeconds));
            
            // æ¯5åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜ä¸€æ¬¡è¿›åº¦
            if (timerSeconds % 300 === 0) {
                autoSaveProgress();
            }
        }, 1000);
        
        console.log("è®¡æ—¶å™¨å¼€å§‹");
    }
    
    // æš‚åœè®¡æ—¶
    function pauseTimer() {
        if (!isTimerRunning) return;
        
        clearInterval(studyTimerInterval);
        isTimerRunning = false;
        pauseBtn.prop('disabled', true);
        startBtn.prop('disabled', false);
        
        console.log("è®¡æ—¶å™¨æš‚åœ");
    }
    
    // åœæ­¢è®¡æ—¶
    function stopTimer() {
        clearInterval(studyTimerInterval);
        isTimerRunning = false;
        
        // æ˜¾ç¤ºå­¦ä¹ ç»“æŸæ¨¡æ€æ¡†
        const durationMinutes = Math.floor(timerSeconds / 60);
        $('#sessionDurationDisplay').text(`${durationMinutes}åˆ†é’Ÿ`);
        
        // æ˜¾ç¤ºå½“å‰ä»»åŠ¡å
        let taskName = "è‡ªç”±å­¦ä¹ ";
        if (selectedTaskName) {
            taskName = selectedTaskName;
        } else if (customTaskName) {
            taskName = customTaskName;
        }
        $('#sessionTaskName').text(taskName);
        
        $('#studyEndModal').modal('show');
        
        console.log("è®¡æ—¶å™¨åœæ­¢ï¼Œæ˜¾ç¤ºç»“æŸæ¨¡æ€æ¡†");
    }
    
    // é‡ç½®è®¡æ—¶å™¨
    function resetTimer() {
        clearInterval(studyTimerInterval);
        timerSeconds = 0;
        activeSessionId = null;
        selectedTaskId = null;
        selectedTaskName = null;
        customTaskName = null;
        usingCustomTask = false;
        isTimerRunning = false;
        
        timerDisplay.text('00:00:00');
        startBtn.prop('disabled', false);
        pauseBtn.prop('disabled', true);
        stopBtn.prop('disabled', true);
        taskSelector.val('');
        customTaskNameInput.val('');
        currentTaskDisplay.hide();
        
        console.log("è®¡æ—¶å™¨é‡ç½®");
    }
    
    // ==================== æŒ‰é’®äº‹ä»¶ç›‘å¬ ====================
    // ä½¿ç”¨è‡ªå®šä¹‰ä»»åŠ¡å
    useCustomTaskBtn.click(function() {
        const customName = customTaskNameInput.val().trim();
        if (!customName) {
            showAlert('è¯·è¾“å…¥ä»»åŠ¡åç§°', 'æç¤º');
            return;
        }
        
        // æ¸…é™¤ä»»åŠ¡é€‰æ‹©å™¨
        taskSelector.val('');
        selectedTaskId = null;
        selectedTaskName = customName;
        customTaskName = customName;
        usingCustomTask = true;
        
        updateCurrentTaskDisplay(customName);
        showToast(`å·²ä½¿ç”¨è‡ªå®šä¹‰ä»»åŠ¡å: ${customName}`, 'success');
        
        console.log("ä½¿ç”¨è‡ªå®šä¹‰ä»»åŠ¡å:", customName);
    });
    
    // ä»»åŠ¡é€‰æ‹©å™¨å˜åŒ–æ—¶
    taskSelector.change(function() {
        const selectedOption = $(this).find('option:selected');
        if (selectedOption.val()) {
            selectedTaskId = selectedOption.val();
            selectedTaskName = selectedOption.data('title');
            customTaskName = null;
            usingCustomTask = false;
            customTaskNameInput.val('');
            
            updateCurrentTaskDisplay(selectedTaskName);
            showToast(`å·²é€‰æ‹©ä»»åŠ¡: ${selectedTaskName}`, 'info');
            
            console.log("é€‰æ‹©ä»»åŠ¡:", selectedTaskName);
        } else {
            // é€‰æ‹©"è‡ªç”±å­¦ä¹ "
            selectedTaskId = null;
            selectedTaskName = "è‡ªç”±å­¦ä¹ ";
            customTaskName = null;
            usingCustomTask = false;
            currentTaskDisplay.hide();
        }
    });
    
    // å¼€å§‹å­¦ä¹ æŒ‰é’®
    startBtn.click(async function() {
        if (!activeSessionId) {
            // å¼€å§‹æ–°çš„å­¦ä¹ ä¼šè¯
            let taskId = selectedTaskId;
            let customName = '';
            
            if (!taskId && usingCustomTask) {
                // ä½¿ç”¨è‡ªå®šä¹‰ä»»åŠ¡å
                customName = customTaskNameInput.val().trim();
                if (!customName) {
                    showAlert('è¯·è¾“å…¥è‡ªå®šä¹‰ä»»åŠ¡å', 'æç¤º');
                    return;
                }
                selectedTaskName = customName;
            } else if (!taskId && !customTaskNameInput.val().trim()) {
                // æ²¡æœ‰é€‰æ‹©ä»»åŠ¡ä¹Ÿæ²¡æœ‰è‡ªå®šä¹‰ä»»åŠ¡å
                selectedTaskName = "è‡ªç”±å­¦ä¹ ";
            }
            
            try {
                const response = await fetch('/api/study/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        task_id: taskId,
                        custom_task_name: customName 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    activeSessionId = data.session_id;
                    timerSeconds = 0;
                    
                    // æ›´æ–°ä»»åŠ¡æ˜¾ç¤º
                    if (customName) {
                        updateCurrentTaskDisplay(customName);
                    } else if (selectedTaskName) {
                        updateCurrentTaskDisplay(selectedTaskName);
                    }
                    
                    startTimer();
                    showToast('å­¦ä¹ è®¡æ—¶å¼€å§‹ï¼', 'success');
                    console.log("æ–°å­¦ä¹ ä¼šè¯å¼€å§‹:", data);
                } else {
                    showAlert(data.message, 'é”™è¯¯');
                }
            } catch (error) {
                console.error('å¼€å§‹å­¦ä¹ å¤±è´¥:', error);
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'é”™è¯¯');
            }
        } else {
            // æ¢å¤è®¡æ—¶
            startTimer();
            showToast('å­¦ä¹ è®¡æ—¶æ¢å¤', 'info');
        }
    });
    
    // æš‚åœæŒ‰é’®
    pauseBtn.click(function() {
        pauseTimer();
        showToast('å­¦ä¹ è®¡æ—¶æš‚åœ', 'warning');
    });
    
    // åœæ­¢æŒ‰é’®
    stopBtn.click(function() {
        if (activeSessionId) {
            stopTimer();
        } else {
            showAlert('è¯·å…ˆå¼€å§‹å­¦ä¹ è®¡æ—¶', 'æç¤º');
        }
    });
    
    // ä¿å­˜å­¦ä¹ è®°å½•
    $('#saveSessionBtn').click(async function() {
        const $btn = $(this);
        $btn.prop('disabled', true).html('<i class="bi bi-hourglass-split me-1"></i>ä¿å­˜ä¸­...');
        
        const focusScore = $('#focusScore').val();
        const notes = $('#sessionNotes').val();
        
        try {
            const response = await fetch('/api/study/end', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    session_id: activeSessionId,
                    focus_score: focusScore,
                    notes: notes
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(`å­¦ä¹ å®Œæˆï¼æœ¬æ¬¡å­¦ä¹ äº† ${data.duration} åˆ†é’Ÿ`, 'success');
                
                // é‡ç½®è®¡æ—¶å™¨
                resetTimer();
                
                // æ›´æ–°ç»Ÿè®¡
                await loadStudyStatistics();
                await loadSessionHistory();
                
                // å…³é—­æ¨¡æ€æ¡†
                $('#studyEndModal').modal('hide');
                
                // æ¸…ç©ºè¡¨å•
                $('#sessionNotes').val('');
                $('.focus-star').removeClass('selected');
                $('.focus-star').eq(2).addClass('selected'); // é‡ç½®ä¸º3æ˜Ÿ
                
                console.log("å­¦ä¹ è®°å½•ä¿å­˜æˆåŠŸ:", data);
            } else {
                showAlert(data.message, 'é”™è¯¯');
            }
        } catch (error) {
            console.error('ä¿å­˜å­¦ä¹ è®°å½•å¤±è´¥:', error);
            showAlert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'é”™è¯¯');
        } finally {
            $btn.prop('disabled', false).html('<i class="bi bi-save me-1"></i>ä¿å­˜å­¦ä¹ è®°å½•');
        }
    });
    
    // ==================== å­¦ä¹ ç»Ÿè®¡åŠŸèƒ½ ====================
    // åŠ è½½å­¦ä¹ ç»Ÿè®¡æ•°æ®
    async function loadStudyStatistics() {
        console.log('å¼€å§‹åŠ è½½å­¦ä¹ ç»Ÿè®¡...');
        
        try {
            const response = await fetch('/api/study/stats');
            const data = await response.json();
            
            console.log('å­¦ä¹ ç»Ÿè®¡APIè¿”å›:', data);
            
            if (data.success) {
                renderStatsCards(data.stats);
                renderPieChart(data.pie_chart);
                renderTrendChart(data.trend_data);
                console.log('ç»Ÿè®¡åŠ è½½æˆåŠŸ');
            } else {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', data.message);
                showEmptyStats();
            }
        } catch (error) {
            console.error('åŠ è½½å­¦ä¹ ç»Ÿè®¡å¤±è´¥:', error);
            showEmptyStats();
        }
    }
    
    // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
    function renderStatsCards(stats) {
        const html = `
            <div class="stat-card">
                <div class="stat-value">${stats.total_study}</div>
                <div class="stat-label">æ€»å­¦ä¹ æ—¶é•¿(åˆ†é’Ÿ)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.week_study}</div>
                <div class="stat-label">æœ¬å‘¨å­¦ä¹ æ—¶é•¿(åˆ†é’Ÿ)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.today_study}</div>
                <div class="stat-label">ä»Šæ—¥å­¦ä¹ æ—¶é•¿(åˆ†é’Ÿ)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.avg_focus}/5</div>
                <div class="stat-label">å¹³å‡ä¸“æ³¨åº¦</div>
            </div>
        `;
        
        statsCards.html(html);
    }
    
    // æ¸²æŸ“é¥¼çŠ¶å›¾
    function renderPieChart(pieData) {
        console.log('æ¸²æŸ“é¥¼çŠ¶å›¾ï¼Œæ•°æ®:', pieData);
        
        const ctx = document.getElementById('studyPieChart');
        if (!ctx) {
            console.error('æ‰¾ä¸åˆ° studyPieChart canvas å…ƒç´ ');
            return;
        }
        
        const context = ctx.getContext('2d');
        
        // é”€æ¯ä¹‹å‰çš„å›¾è¡¨
        if (pieChart) {
            pieChart.destroy();
            pieChart = null;
        }
        
        // æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰æ•ˆ
        if (!pieData || !pieData.labels || !pieData.datasets || pieData.labels.length === 0) {
            console.error('é¥¼çŠ¶å›¾æ•°æ®æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸ºç©º:', pieData);
            
            // æ˜¾ç¤ºé»˜è®¤æ•°æ®
            pieData = {
                labels: ['æš‚æ— å­¦ä¹ æ•°æ®'],
                datasets: [{
                    data: [100],
                    backgroundColor: ['#e2e8f0'],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            };
        }
        
        console.log('æœ€ç»ˆé¥¼çŠ¶å›¾æ•°æ®:', pieData);
        
        try {
            pieChart = new Chart(context, {
                type: 'pie',
                data: pieData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value}åˆ†é’Ÿ (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('é¥¼çŠ¶å›¾æ¸²æŸ“æˆåŠŸ');
        } catch (error) {
            console.error('æ¸²æŸ“é¥¼çŠ¶å›¾å¤±è´¥:', error);
            showAlert('æ¸²æŸ“é¥¼çŠ¶å›¾å¤±è´¥: ' + error.message, 'é”™è¯¯');
        }
    }
    
    // æ¸²æŸ“è¶‹åŠ¿å›¾
    function renderTrendChart(trendData) {
        const ctx = document.getElementById('studyTrendChart').getContext('2d');
        
        // æå–æ•°æ®
        const dates = trendData.map(item => item.date);
        const durations = trendData.map(item => item.duration);
        
        // é”€æ¯ä¹‹å‰çš„å›¾è¡¨
        if (trendChart) {
            trendChart.destroy();
            trendChart = null;
        }
        
        try {
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'å­¦ä¹ æ—¶é•¿(åˆ†é’Ÿ)',
                        data: durations,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'åˆ†é’Ÿ'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    }
                }
            });
            
            console.log('è¶‹åŠ¿å›¾æ¸²æŸ“æˆåŠŸ');
        } catch (error) {
            console.error('æ¸²æŸ“è¶‹åŠ¿å›¾å¤±è´¥:', error);
        }
    }
    
    // åŠ è½½å­¦ä¹ å†å²
    async function loadSessionHistory() {
        try {
            const response = await fetch('/api/study/sessions?per_page=10');
            const data = await response.json();
            
            if (data.success && data.sessions.length > 0) {
                renderSessionHistory(data.sessions);
                console.log('å­¦ä¹ å†å²åŠ è½½æˆåŠŸï¼Œå…±', data.sessions.length, 'æ¡è®°å½•');
            } else {
                showEmptySessionHistory();
            }
        } catch (error) {
            console.error('åŠ è½½å­¦ä¹ å†å²å¤±è´¥:', error);
            showEmptySessionHistory();
        }
    }
    
    // æ¸²æŸ“å­¦ä¹ å†å²
    function renderSessionHistory(sessions) {
        let html = `
            <h6 class="mb-3">
                <i class="bi bi-clock-history text-primary me-2"></i>æœ€è¿‘å­¦ä¹ è®°å½•
            </h6>
        `;
        
        sessions.forEach(session => {
            const focusStars = 'â˜…'.repeat(session.focus_score) + 'â˜†'.repeat(5 - session.focus_score);
            const notes = session.notes ? `<div class="session-notes">${session.notes}</div>` : '';
            
            html += `
                <div class="session-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="session-duration">${session.duration}åˆ†é’Ÿ</div>
                            <div class="session-date">
                                ${session.date} ${session.start_time} - ${session.end_time}
                            </div>
                            <div class="text-muted small mt-1">
                                <i class="bi bi-journal-text me-1"></i>${session.task_name}
                                <span class="ms-3">
                                    <i class="bi bi-star me-1"></i>${focusStars}
                                </span>
                            </div>
                            ${notes}
                        </div>
                        <button class="btn btn-sm btn-outline-danger delete-session-btn" 
                                data-session-id="${session.id}" 
                                title="åˆ é™¤è®°å½•">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        sessionHistory.html(html);
        
        // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
        $('.delete-session-btn').click(async function() {
            const sessionId = $(this).data('session-id');
            
            const isConfirmed = await showConfirm(
                'ç¡®å®šè¦åˆ é™¤è¿™æ¡å­¦ä¹ è®°å½•å—ï¼Ÿ',
                'ç¡®è®¤åˆ é™¤'
            );
            
            if (isConfirmed) {
                try {
                    const response = await fetch(`/api/study/delete/${sessionId}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showToast('å­¦ä¹ è®°å½•å·²åˆ é™¤', 'success');
                        await loadSessionHistory();
                        await loadStudyStatistics();
                    } else {
                        showAlert(data.message, 'é”™è¯¯');
                    }
                } catch (error) {
                    console.error('åˆ é™¤å­¦ä¹ è®°å½•å¤±è´¥:', error);
                    showAlert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'é”™è¯¯');
                }
            }
        });
    }
    
    // æ˜¾ç¤ºç©ºçš„ç»Ÿè®¡ä¿¡æ¯
    function showEmptyStats() {
        statsCards.html(`
            <div class="col-12">
                <div class="empty-stats">
                    <i class="bi bi-graph-up"></i>
                    <h6 class="mt-3">æš‚æ— å­¦ä¹ ç»Ÿè®¡</h6>
                    <p class="text-muted small">å¼€å§‹ä½¿ç”¨å­¦ä¹ è®¡æ—¶å™¨åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºä½ çš„å­¦ä¹ æ•°æ®</p>
                </div>
            </div>
        `);
        
        // æ¸…ç©ºå›¾è¡¨
        if (pieChart) {
            pieChart.destroy();
            pieChart = null;
        }
        
        if (trendChart) {
            trendChart.destroy();
            trendChart = null;
        }
    }
    
    // æ˜¾ç¤ºç©ºçš„å­¦ä¹ å†å²
    function showEmptySessionHistory() {
        sessionHistory.html(`
            <div class="empty-stats">
                <i class="bi bi-clock-history"></i>
                <h6 class="mt-3">æš‚æ— å­¦ä¹ è®°å½•</h6>
                <p class="text-muted small">å¼€å§‹ä½¿ç”¨å­¦ä¹ è®¡æ—¶å™¨åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºä½ çš„å­¦ä¹ å†å²</p>
            </div>
        `);
    }
    
    // åˆ·æ–°ç»Ÿè®¡æŒ‰é’®
    refreshStatsBtn.click(async function() {
        const $btn = $(this);
        $btn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i>');
        
        await loadStudyStatistics();
        await loadSessionHistory();
        
        $btn.prop('disabled', false).html('<i class="bi bi-arrow-clockwise"></i>åˆ·æ–°');
        showToast('å­¦ä¹ ç»Ÿè®¡å·²åˆ·æ–°', 'success');
    });
    
    // ==================== å…¶ä»–åŠŸèƒ½ ====================
    // é¡µé¢å¸è½½å‰æç¤º
    window.addEventListener('beforeunload', function(e) {
        if (activeSessionId && isTimerRunning) {
            e.preventDefault();
            e.returnValue = 'ä½ æœ‰æ­£åœ¨è¿›è¡Œçš„å­¦ä¹ ä¼šè¯ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
            return e.returnValue;
        }
    });
    
    // è‡ªåŠ¨ä¿å­˜è¿›åº¦
    async function autoSaveProgress() {
        if (!activeSessionId) return;
        
        try {
            await fetch('/api/study/end', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    session_id: activeSessionId,
                    duration_minutes: Math.floor(timerSeconds / 60)
                })
            });
            console.log('è‡ªåŠ¨ä¿å­˜è¿›åº¦');
        } catch (error) {
            console.error('è‡ªåŠ¨ä¿å­˜è¿›åº¦å¤±è´¥:', error);
        }
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä»Šå¤©åˆ°æœŸçš„ä»»åŠ¡
    setTimeout(() => {
        const todayDueTasks = $('.due-date-badge.due-date-soon').length;
        if (todayDueTasks > 0) {
            showAlert(`ä½ æœ‰ ${todayDueTasks} ä¸ªä»»åŠ¡å³å°†åˆ°æœŸï¼Œè¯·åŠæ—¶å¤„ç†ï¼`, 'ä»»åŠ¡æé†’');
        }
    }, 2000);
    
    // åˆå§‹åŒ–
    initializeStudyTimer();
    // ==================== ä»»åŠ¡ç®¡ç†åŠŸèƒ½ ====================
    
    // 1. å®Œæˆå•ä¸ªä»»åŠ¡
    $(document).on('click', '.complete-task-btn', async function(e) {
        e.stopPropagation();
        const taskId = $(this).data('task-id');
        const taskTitle = $(this).data('task-title');
        
        const isConfirmed = await showConfirm(
            `ç¡®å®šè¦å°†ä»»åŠ¡ "${taskTitle}" æ ‡è®°ä¸ºå®Œæˆå—ï¼Ÿ`,
            'ç¡®è®¤å®Œæˆ'
        );
        
        if (isConfirmed) {
            try {
                console.log(`æ­£åœ¨å®Œæˆä»»åŠ¡: ${taskId}`);
                const response = await fetch(`/complete_task/${taskId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('å®Œæˆå“åº”:', data);
                
                if (data.success) {
                    showToast('ä»»åŠ¡å·²å®Œæˆï¼', 'success');
                    // åˆ·æ–°é¡µé¢
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showAlert(data.message || 'æ“ä½œå¤±è´¥', 'é”™è¯¯');
                }
            } catch (error) {
                console.error('å®Œæˆä»»åŠ¡å¤±è´¥:', error);
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'é”™è¯¯');
            }
        }
    });
    
    // 2. ç¼–è¾‘ä»»åŠ¡ - æ‰“å¼€æ¨¡æ€æ¡†
    $(document).on('click', '.edit-task-btn', function(e) {
        e.stopPropagation();
        
        const taskId = $(this).data('task-id');
        const taskTitle = $(this).data('task-title');
        const taskDesc = $(this).data('task-desc');
        const taskPriority = $(this).data('task-priority');
        const taskDueDate = $(this).data('task-due-date');
        
        console.log('ç¼–è¾‘ä»»åŠ¡:', {taskId, taskTitle, taskDesc, taskPriority, taskDueDate});
        
        // å¡«å……ç¼–è¾‘æ¨¡æ€æ¡†
        $('#editTaskId').val(taskId);
        $('#editTaskTitle').val(taskTitle);
        $('#editTaskDesc').val(taskDesc);
        $('#editTaskPriority').val(taskPriority);
        $('#editTaskDueDate').val(taskDueDate);
        
        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        $('#editTaskModal').modal('show');
    });
    
    // 3. åˆ é™¤å•ä¸ªä»»åŠ¡
    $(document).on('click', '.delete-task-btn', async function(e) {
        e.stopPropagation();
        const taskId = $(this).data('task-id');
        const taskTitle = $(this).data('task-title');
        
        const isConfirmed = await showConfirm(
            `ç¡®å®šè¦åˆ é™¤ä»»åŠ¡ "${taskTitle}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
            'ç¡®è®¤åˆ é™¤'
        );
        
        if (isConfirmed) {
            try {
                console.log(`æ­£åœ¨åˆ é™¤ä»»åŠ¡: ${taskId}`);
                const response = await fetch(`/delete_task/${taskId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('åˆ é™¤å“åº”:', data);
                
                if (data.success) {
                    showToast('ä»»åŠ¡å·²åˆ é™¤ï¼', 'success');
                    // ç§»é™¤ä»»åŠ¡å¡ç‰‡
                    $(`[data-id="${taskId}"]`).fadeOut(300, function() {
                        $(this).remove();
                        updateTaskCounts();
                    });
                } else {
                    showAlert(data.message || 'åˆ é™¤å¤±è´¥', 'é”™è¯¯');
                }
            } catch (error) {
                console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'é”™è¯¯');
            }
        }
    });
    
    // 4. æäº¤ç¼–è¾‘ä»»åŠ¡è¡¨å•
    $('#editTaskForm').submit(async function(e) {
        e.preventDefault();
        
        const taskId = $('#editTaskId').val();
        const formData = {
            title: $('#editTaskTitle').val().trim(),
            description: $('#editTaskDesc').val().trim(),
            priority: $('#editTaskPriority').val(),
            due_date: $('#editTaskDueDate').val(),
            status: $('#editTaskStatus').val()
        };
        
        console.log('æäº¤ç¼–è¾‘:', taskId, formData);
        
        // éªŒè¯
        if (!formData.title) {
            showAlert('è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜', 'æç¤º');
            return;
        }
        
        try {
            const response = await fetch(`/edit_task/${taskId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            console.log('ç¼–è¾‘å“åº”:', data);
            
            if (data.success) {
                showToast('ä»»åŠ¡å·²æ›´æ–°ï¼', 'success');
                $('#editTaskModal').modal('hide');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showAlert(data.message || 'æ›´æ–°å¤±è´¥', 'é”™è¯¯');
            }
        } catch (error) {
            console.error('æ›´æ–°ä»»åŠ¡å¤±è´¥:', error);
            showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'é”™è¯¯');
        }
    });
    
    // ==================== æ‰¹é‡æ“ä½œåŠŸèƒ½ ====================
    
    // 5. å…¨é€‰/å–æ¶ˆå…¨é€‰
    $('#selectAllTasks').change(function() {
        const isChecked = $(this).prop('checked');
        $('.task-checkbox').prop('checked', isChecked);
        updateBatchActions();
    });
    
    // 6. å•ä¸ªå¤é€‰æ¡†å˜åŒ–æ—¶æ›´æ–°
    $(document).on('change', '.task-checkbox', function() {
        updateBatchActions();
    });
    
    // 7. æ›´æ–°æ‰¹é‡æ“ä½œæ˜¾ç¤º
    function updateBatchActions() {
        const selectedCount = $('.task-checkbox:checked').length;
        console.log('å·²é€‰æ‹©:', selectedCount);
        
        if (selectedCount > 0) {
            $('#selectedCount').text(selectedCount);
            $('#batchActions').slideDown();
        } else {
            $('#batchActions').slideUp();
        }
    }
    
    // 8. æ‰¹é‡å®Œæˆä»»åŠ¡
    $('#batchCompleteBtn').click(async function() {
        const selectedTasks = [];
        $('.task-checkbox:checked').each(function() {
            selectedTasks.push($(this).val());
        });
        
        if (selectedTasks.length === 0) {
            showAlert('è¯·å…ˆé€‰æ‹©è¦å®Œæˆçš„ä»»åŠ¡', 'æç¤º');
            return;
        }
        
        console.log('æ‰¹é‡å®Œæˆä»»åŠ¡:', selectedTasks);
        
        const isConfirmed = await showConfirm(
            `ç¡®å®šè¦æ‰¹é‡å®Œæˆ ${selectedTasks.length} ä¸ªä»»åŠ¡å—ï¼Ÿ`,
            'ç¡®è®¤æ‰¹é‡å®Œæˆ'
        );
        
        if (isConfirmed) {
            try {
                const response = await fetch('/batch_complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ task_ids: selectedTasks })
                });
                
                const data = await response.json();
                console.log('æ‰¹é‡å®Œæˆå“åº”:', data);
                
                if (data.success) {
                    showToast(`å·²æ‰¹é‡å®Œæˆ ${selectedTasks.length} ä¸ªä»»åŠ¡ï¼`, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showAlert(data.message || 'æ‰¹é‡å®Œæˆå¤±è´¥', 'é”™è¯¯');
                }
            } catch (error) {
                console.error('æ‰¹é‡å®Œæˆä»»åŠ¡å¤±è´¥:', error);
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'é”™è¯¯');
            }
        }
    });
    
    // 9. æ‰¹é‡åˆ é™¤ä»»åŠ¡
    $('#batchDeleteBtn').click(async function() {
        const selectedTasks = [];
        $('.task-checkbox:checked').each(function() {
            selectedTasks.push($(this).val());
        });
        
        if (selectedTasks.length === 0) {
            showAlert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ä»»åŠ¡', 'æç¤º');
            return;
        }
        
        console.log('æ‰¹é‡åˆ é™¤ä»»åŠ¡:', selectedTasks);
        
        const isConfirmed = await showConfirm(
            `ç¡®å®šè¦æ‰¹é‡åˆ é™¤ ${selectedTasks.length} ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
            'ç¡®è®¤æ‰¹é‡åˆ é™¤'
        );
        
        if (isConfirmed) {
            try {
                const response = await fetch('/batch_delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ task_ids: selectedTasks })
                });
                
                const data = await response.json();
                console.log('æ‰¹é‡åˆ é™¤å“åº”:', data);
                
                if (data.success) {
                    showToast(`å·²æ‰¹é‡åˆ é™¤ ${selectedTasks.length} ä¸ªä»»åŠ¡ï¼`, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showAlert(data.message || 'æ‰¹é‡åˆ é™¤å¤±è´¥', 'é”™è¯¯');
                }
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'é”™è¯¯');
            }
        }
    });
    
    // 10. æ›´æ–°ä»»åŠ¡ç»Ÿè®¡
    function updateTaskCounts() {
        const totalTasks = $('.task-item').length;
        const completedTasks = $('.task-item[data-status="completed"]').length;
        const pendingTasks = totalTasks - completedTasks;
        
        // æ›´æ–°æ˜¾ç¤º
        $('.text-muted.small').last().html(`
            å…± ${totalTasks} ä¸ªä»»åŠ¡ï¼Œ${completedTasks} ä¸ªå·²å®Œæˆ
        `);
        
        console.log('æ›´æ–°ç»Ÿè®¡:', {totalTasks, completedTasks, pendingTasks});
    }
    
    // 11. åˆå§‹åŒ–æ‰¹é‡æ“ä½œæ˜¾ç¤º
    updateBatchActions();
    
    // 12. æµ‹è¯•ï¼šæ·»åŠ ä¸€äº›æ—¥å¿—
    console.log('ä»»åŠ¡ç®¡ç†åŠŸèƒ½å·²åŠ è½½');
    console.log('å½“å‰ä»»åŠ¡æ•°é‡:', $('.task-item').length);
    console.log('å®ŒæˆæŒ‰é’®æ•°é‡:', $('.complete-task-btn').length);
    console.log('åˆ é™¤æŒ‰é’®æ•°é‡:', $('.delete-task-btn').length);
});
</script>
{% endblock %}