{% extends "base.html" %}

{% block title %}AI æ™ºèƒ½åŠ©æ‰‹ - æ——èˆ°ç‰ˆ{% endblock %}

{% block extra_css %}
<!-- å¼•å…¥ Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
    /* === æ•´ä½“å¸ƒå±€ === */
    .ai-chat-container {
        background: #f8f9fa;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        height: calc(100vh - 160px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #e9ecef;
        position: relative;
    }

    /* === å¤´éƒ¨ === */
    .chat-header {
        background: white;
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
    }

    /* === æ¶ˆæ¯åˆ—è¡¨åŒºåŸŸ === */
    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
        scroll-behavior: smooth;
    }

    /* === æ¶ˆæ¯æ°”æ³¡ === */
    .message {
        display: flex;
        gap: 12px;
        max-width: 85%; /* é»˜è®¤æ–‡æœ¬å®½åº¦ */
        animation: fadeIn 0.3s ease;
    }
    
    /* é’ˆå¯¹ AI æ¶ˆæ¯ï¼ˆåŒ…å«å›¾è¡¨ï¼‰ç‰¹åˆ«æ”¾å®½å®½åº¦é™åˆ¶ */
    .message.ai {
        align-self: flex-start;
        max-width: 98%; /* è®©å›¾è¡¨å¯ä»¥å±•ç¤ºå¾—å¾ˆå®½ */
    }

    .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 20px;
        color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .avatar.user-avatar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .avatar.ai-avatar { background: linear-gradient(135deg, #00c6fb 0%, #005bea 100%); }

    .message-content {
        padding: 12px 18px;
        border-radius: 16px;
        font-size: 15px;
        line-height: 1.6;
        position: relative;
        word-break: break-word;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .message.user .message-content {
        background: #4e73df;
        color: white;
        border-bottom-right-radius: 2px;
    }

    .message.ai .message-content {
        background: white;
        color: #333;
        border: 1px solid #eee;
        border-bottom-left-radius: 2px;
        width: fit-content; /* è®©å®½åº¦è‡ªé€‚åº”å†…å®¹ */
    }

    /* === å¿«æ·è¯¢é—®æ  (Suggestion Chips) === */
    .quick-actions {
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.9);
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        overflow-x: auto;
        white-space: nowrap;
        scrollbar-width: none; /* éšè—æ»šåŠ¨æ¡ */
    }
    .quick-actions::-webkit-scrollbar { display: none; }

    .chip {
        background: white;
        border: 1px solid #dee2e6;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        color: #555;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .chip:hover {
        background: #eef2ff;
        border-color: #4e73df;
        color: #4e73df;
        transform: translateY(-2px);
    }
    .chip i { font-size: 14px; }

    /* === è¾“å…¥åŒºåŸŸ === */
    .chat-input-area {
        background: white;
        padding: 15px 20px;
    }

    .input-wrapper {
        display: flex;
        gap: 10px;
        background: #f8f9fa;
        padding: 8px;
        border-radius: 12px;
        border: 1px solid #ddd;
        transition: border-color 0.3s;
    }

    .input-wrapper:focus-within {
        border-color: #4e73df;
        box-shadow: 0 0 0 3px rgba(78,115,223,0.1);
    }

    #chatInput {
        flex: 1;
        border: none;
        background: transparent;
        padding: 8px;
        outline: none;
        font-size: 15px;
    }

    #sendBtn {
        border: none;
        background: #4e73df;
        color: white;
        width: 45px;
        height: 45px;
        border-radius: 10px;
        cursor: pointer;
        transition: transform 0.2s;
    }
    #sendBtn:hover { background: #2e59d9; transform: scale(1.05); }
    #sendBtn:disabled { background: #ccc; cursor: not-allowed; }

    /* === é…ç½®é¢æ¿ === */
    .config-panel {
        background: #fff;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 20px;
        margin-top: 15px;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .config-panel.show { display: block; animation: slideDown 0.3s; }

    /* === å›¾è¡¨å®¹å™¨æ ·å¼ä¼˜åŒ– === */
    .chart-box {
        width: 100%;
        min-width: 650px; /* å¼ºåˆ¶æœ€å°å®½åº¦ï¼Œé˜²æ­¢æŒ¤å‹ */
        height: 400px;
        background: #fff;
        border-radius: 8px;
        margin-top: 10px;
    }
    /* ç§»åŠ¨ç«¯é€‚é…ï¼šå…è®¸æ»šåŠ¨ */
    @media (max-width: 768px) {
        .chart-box { min-width: 300px; height: 300px; }
        .message.ai { max-width: 100%; }
        .quick-actions { padding: 10px; }
    }

    /* === åŠ¨ç”» === */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    .typing { display: none; margin-left: 50px; font-size: 12px; color: #999; margin-bottom: 10px; }
    .typing.active { display: block; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    
    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <div class="d-flex justify-content-between align-items-center mb-3 mt-4">
        <div>
            <h1 class="h3 text-gray-800 fw-bold"><i class="bi bi-robot text-primary me-2"></i>CampusPulse æ™ºèƒ½ä¸­æ¢</h1>
            <p class="text-muted small mb-0">é›†æˆ GPT-4 çº§å¯¹è¯ã€AI ç»˜å›¾ä¸å¯è§†åŒ–åˆ†æ</p >
        </div>
        <button class="btn btn-white border shadow-sm text-primary" onclick="toggleConfig()">
            <i class="bi bi-sliders me-1"></i> æ¨¡å‹ä¸é…ç½®
        </button>
    </div>

    <!-- API é…ç½®é¢æ¿ (å¸¦æ¨¡å‹é€‰æ‹©) -->
    <div class="config-panel mb-4" id="configPanel">
        <h6 class="fw-bold mb-3"><i class="bi bi-gear-fill"></i> ç³»ç»Ÿè®¾ç½®</h6>
        <div class="row g-3">
            <!-- API Key è¾“å…¥ -->
            <div class="col-md-6">
                <label class="form-label small text-muted">æ™ºè°±æ¸…è¨€ API Key</label>
                <input type="password" id="apiKeyInput" class="form-control" placeholder="è¯·è¾“å…¥ API Key...">
            </div>
            <!-- æ¨¡å‹é€‰æ‹© (æ–°å¢) -->
            <div class="col-md-4">
                <label class="form-label small text-muted">é€‰æ‹© AI æ¨¡å‹</label>
                <select class="form-select" id="modelSelect">
                    <option value="glm-4">GLM-4 (æ›´æ™ºèƒ½/æ¨è)</option>
                    <option value="glm-4-plus">GLM-4 Plus (æœ€å¼º)</option>
                    <option value="glm-3-turbo">GLM-3 Turbo (é€Ÿåº¦å¿«)</option>
                </select>
            </div>
            <!-- ä¿å­˜æŒ‰é’® -->
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary w-100" onclick="saveConfig()">
                    <i class="bi bi-save"></i> ä¿å­˜
                </button>
            </div>
        </div>
        <div class="small text-muted mt-2">
            <i class="bi bi-shield-lock"></i> æ‚¨çš„ Key ä»…å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œå®‰å…¨æ— å¿§ã€‚
        </div>
    </div>

    <!-- èŠå¤©ä¸»ç•Œé¢ -->
    <div class="ai-chat-container">
        
        <!-- æ¶ˆæ¯åˆ—è¡¨ -->
        <div class="chat-messages" id="chatMessages">
            <!-- æ¬¢è¿æ¶ˆæ¯ -->
            <div class="message ai">
                <div class="avatar ai-avatar"><i class="bi bi-robot"></i></div>
                <div class="message-content">
                    ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å…¨èƒ½ AI ä¼™ä¼´ã€‚ä½ å¯ä»¥ç‚¹å‡»ä¸‹æ–¹å¿«æ·æŒ‰é’®ï¼Œæˆ–ç›´æ¥é—®æˆ‘ï¼š<br>
                    <div class="mt-2 text-muted small">
                        â€¢ ç”Ÿæˆå›¾è¡¨ï¼š<b>"ç»Ÿè®¡æœ¬å‘¨å­¦ä¹ æ—¶é•¿å¹¶ç”Ÿæˆå›¾è¡¨"</b><br>
                        â€¢ AI ç»˜ç”»ï¼š<b>"ç”»ä¸€å¼ æœªæ¥åŸå¸‚çš„å›¾ç‰‡"</b><br>
                        â€¢ çŸ¥è¯†é—®ç­”ï¼š<b>"è§£é‡Šä¸€ä¸‹æ·±åº¦å­¦ä¹ "</b>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI æ€è€ƒçŠ¶æ€ -->
        <div class="typing" id="typingIndicator">
            <span class="spinner-grow spinner-grow-sm text-primary" role="status"></span>
            <span class="ms-2">AI æ­£åœ¨æ·±åº¦æ€è€ƒä¸­...</span>
        </div>

        <!-- å¿«æ·è¯¢é—®æ  (æ–°å¢) -->
        <div class="quick-actions">
            <div class="chip" onclick="usePrompt('å¸®æˆ‘åˆ¶å®šä»Šå¤©çš„å­¦ä¹ è®¡åˆ’')">
                <i class="bi bi-calendar-check"></i> åˆ¶å®šè®¡åˆ’
            </div>
            <div class="chip" onclick="usePrompt('ç»Ÿè®¡è¿™å‘¨çš„å­¦ä¹ æ—¶é•¿ï¼šå‘¨ä¸€4å°æ—¶ï¼Œå‘¨äºŒ5å°æ—¶ï¼Œå‘¨ä¸‰3å°æ—¶ï¼Œç”ŸæˆæŸ±çŠ¶å›¾')">
                <i class="bi bi-bar-chart-fill"></i> ç”Ÿæˆç¤ºä¾‹å›¾è¡¨
            </div>
            <div class="chip" onclick="usePrompt('ç”»ä¸€å¼ èµ›åšæœ‹å…‹é£æ ¼çš„å›¾ä¹¦é¦†')">
                <i class="bi bi-palette-fill"></i> ç”»ä¸€å¼ å›¾
            </div>
            <div class="chip" onclick="usePrompt('è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯Pythonåˆ—è¡¨æ¨å¯¼å¼')">
                <i class="bi bi-code-slash"></i> PythonçŸ¥è¯†
            </div>
            <div class="chip" onclick="usePrompt('å¦‚ä½•ç¼“è§£è€ƒå‰ç„¦è™‘ï¼Ÿ')">
                <i class="bi bi-heart-pulse"></i> å¿ƒç†è°ƒèŠ‚
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="chat-input-area">
            <div class="input-wrapper">
                <input type="text" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜... (æŒ‰ Enter å‘é€)" autocomplete="off">
                <button id="sendBtn" onclick="sendMessage()"><i class="bi bi-send-fill"></i></button>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <span class="small text-muted" id="statusText">
                    <i class="bi bi-circle-fill text-secondary me-1" style="font-size: 8px;"></i>ç­‰å¾…è¿æ¥
                </span>
                <button class="btn btn-link btn-sm text-muted text-decoration-none p-0" onclick="clearChat()">
                    <i class="bi bi-trash"></i> æ¸…ç©ºå¯¹è¯
                </button>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<!-- å¼•å…¥ ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<script>
// ================= å…¨å±€é…ç½® =================
const CONFIG = {
    url: 'https://open.bigmodel.cn/api/paas/v4/chat/completions',
    imgUrl: 'https://open.bigmodel.cn/api/paas/v4/images/generations',
    key: localStorage.getItem('zhipu_apikey') || '',
    model: localStorage.getItem('zhipu_model') || 'glm-4' // è¯»å–å­˜å‚¨çš„æ¨¡å‹
};

// DOM å…ƒç´ å¼•ç”¨
const dom = {
    msgList: document.getElementById('chatMessages'),
    input: document.getElementById('chatInput'),
    typing: document.getElementById('typingIndicator'),
    keyInput: document.getElementById('apiKeyInput'),
    modelSelect: document.getElementById('modelSelect'),
    configPanel: document.getElementById('configPanel'),
    status: document.getElementById('statusText')
};

// åˆå§‹åŒ–åŠ è½½
window.onload = () => {
    dom.keyInput.value = CONFIG.key;
    dom.modelSelect.value = CONFIG.model; // è®¾ç½®ä¸‹æ‹‰æ¡†é€‰ä¸­çŠ¶æ€
    updateStatus();
    dom.input.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
};

// ================= åŠŸèƒ½ï¼šå‘é€æ¶ˆæ¯è·¯ç”± =================
function sendMessage() {
    const text = dom.input.value.trim();
    if (!text) return;
    if (!CONFIG.key) { alert('è¯·å…ˆåœ¨å³ä¸Šè§’é…ç½® API Key'); toggleConfig(); return; }

    addMessage(text, 'user');
    dom.input.value = '';
    setLoading(true);

    // æ„å›¾åˆ¤æ–­
    const isChart = text.includes('å›¾è¡¨') || text.includes('ç»Ÿè®¡') || text.includes('è¶‹åŠ¿') || text.includes('åˆ†æ') || text.includes('å¯è§†åŒ–');
    const isDraw = text.startsWith('/img') || text.includes('ç”»ä¸€å¼ ') || (text.includes('ç”Ÿæˆ') && text.includes('å›¾ç‰‡')) || text.includes('ç»˜å›¾');

    if (isChart) {
        requestChart(text); // å›¾è¡¨æ¨¡å¼
    } else if (isDraw) {
        const prompt = text.replace('/img', '').replace('ç”»ä¸€å¼ ', '').replace('ç”Ÿæˆå›¾ç‰‡', '').trim();
        requestImage(prompt); // ç”Ÿå›¾æ¨¡å¼
    } else {
        requestChat(text); // èŠå¤©æ¨¡å¼
    }
}
// ================= æ¨¡å¼ 1ï¼šç”Ÿæˆå›¾è¡¨ (å¸¦ä¿å­˜åŠŸèƒ½) =================
async function requestChart(userPrompt) {
    try {
        const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªEChartsä¸“å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·æ•°æ®ç”Ÿæˆ option JSONã€‚
        ã€ä¸¥æ ¼è¦æ±‚ã€‘ï¼š
        1. åªè¿”å› JSONï¼Œä¸è¦ Markdownï¼Œä¸è¦è§£é‡Šã€‚
        2. å¿…é¡»åŒ…å« toolbox: { feature: { saveAsImage: { title: "ä¿å­˜" } } } ä»¥ä¾¿ç”¨æˆ·ä¸‹è½½ã€‚
        3. å¿…é¡»åŒ…å« tooltip å’Œ legendã€‚
        4. ç¡®ä¿ JSON æ ¼å¼æ ‡å‡†ï¼ˆkeyç”¨åŒå¼•å·ï¼‰ã€‚
        `;

        const response = await fetch(CONFIG.url, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${CONFIG.key}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: CONFIG.model, // ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æ¨¡å‹
                messages: [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userPrompt }
                ],
                temperature: 0.1
            })
        });

        const data = await response.json();
        const aiText = data.choices[0].message.content;
        renderChart(aiText);

    } catch (e) {
        addMessage(`ç”Ÿæˆå›¾è¡¨å¤±è´¥: ${e.message}`, 'ai');
    } finally {
        setLoading(false);
    }
}

// ================= æ¨¡å¼ 2ï¼šç”Ÿæˆå›¾ç‰‡ =================
async function requestImage(prompt) {
    addMessage(`æ­£åœ¨è°ƒç”¨ CogView ç»˜åˆ¶ï¼š${prompt}...`, 'ai');
    try {
        const response = await fetch(CONFIG.imgUrl, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${CONFIG.key}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ model: 'cogview-3', prompt: prompt })
        });
        const data = await response.json();
        if(data.data) {
            const imgHTML = `
                <div>ğŸ¨ ç»˜ç”»å®Œæˆï¼š</div>
                < img src="${data.data[0].url}" style="max-width: 100%; border-radius: 12px; margin-top: 10px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" onclick="window.open(this.src)">
            `;
            addMessage(imgHTML, 'ai', true);
        } else {
            throw new Error('ç”Ÿæˆå¤±è´¥ï¼Œå¯èƒ½æ˜¯ Prompt è¿è§„æˆ–ä½™é¢ä¸è¶³');
        }
    } catch (e) {
        addMessage(`ç»˜ç”»å‡ºé”™: ${e.message}`, 'ai');
    } finally {
        setLoading(false);
    }
}

// ================= æ¨¡å¼ 3ï¼šæ™®é€šèŠå¤© =================
async function requestChat(text) {
    try {
        const response = await fetch(CONFIG.url, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${CONFIG.key}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: CONFIG.model, // ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æ¨¡å‹
                messages: [{ role: 'user', content: text }],
                temperature: 0.7
            })
        });
        const data = await response.json();
        addMessage(data.choices[0].message.content, 'ai');
    } catch (e) {
        addMessage(`è¿æ¥é”™è¯¯: ${e.message}`, 'ai');
    } finally {
        setLoading(false);
    }
}

// ================= æ ¸å¿ƒï¼šå›¾è¡¨æ¸²æŸ“ (å¸¦è‡ªåŠ¨æ³¨å…¥ä¿å­˜æŒ‰é’®) =================
function renderChart(rawText) {
    // 1. æ¸…æ´—æ•°æ®
    let jsonStr = rawText.replace(/```json|```|const option =|var option =/g, '').replace(/\/\/.*$/gm, '').trim();
    const match = jsonStr.match(/(\{[\s\S]*\})/);
    if (match) jsonStr = match[0];

    try {
        let option = new Function(`return ${jsonStr}`)();
        
        // 2. å¼ºåˆ¶æ³¨å…¥â€œä¿å­˜å›¾ç‰‡â€æŒ‰é’®é…ç½® (Magic Fix)
        if (!option.toolbox) option.toolbox = {};
        if (!option.toolbox.feature) option.toolbox.feature = {};
        option.toolbox.feature.saveAsImage = { 
            show: true, 
            title: 'ä¿å­˜å›¾è¡¨',
            pixelRatio: 2 
        };

        // 3. æ¸²æŸ“
        const chartId = 'chart_' + Date.now();
        // æ³¨æ„ï¼šè¿™é‡Œ class="chart-box" å¯¹åº”äº† CSS ä¸­çš„å®½é«˜åº¦è®¾ç½®
        const html = `
            <div>ğŸ“Š åˆ†æç»“æœï¼š</div>
            <div id="${chartId}" class="chart-box"></div>
        `;
        addMessage(html, 'ai', true);

        setTimeout(() => {
            const el = document.getElementById(chartId);
            if (el) {
                const myChart = echarts.init(el);
                myChart.setOption(option);
                window.addEventListener('resize', () => myChart.resize());
            }
        }, 100);

    } catch (e) {
        addMessage("å›¾è¡¨æ•°æ®è§£æå¤±è´¥ï¼Œè½¬ä¸ºæ–‡æœ¬æ˜¾ç¤ºï¼š<br>" + rawText, 'ai', true);
    }
}

// ================= è¾…åŠ©å‡½æ•° =================
function addMessage(content, role, isHTML = false) {
    const div = document.createElement('div');
    div.className = `message ${role}`;
    
    div.innerHTML = `
        <div class="avatar ${role}-avatar">
            <i class="bi ${role === 'user' ? 'bi-person-fill' : 'bi-robot'}"></i>
        </div>
        <div class="message-content">
            ${isHTML ? content : content.replace(/\n/g, '<br>')}
        </div>
    `;
    dom.msgList.appendChild(div);
    dom.msgList.scrollTop = dom.msgList.scrollHeight;
}

// å¿«æ·è¯¢é—®
function usePrompt(text) {
    dom.input.value = text;
    sendMessage();
}

function setLoading(isLoading) {
    dom.typing.className = isLoading ? 'typing active' : 'typing';
    document.getElementById('sendBtn').disabled = isLoading;
}

function toggleConfig() {
    dom.configPanel.classList.toggle('show');
}

function saveConfig() {
    const key = dom.keyInput.value.trim();
    const model = dom.modelSelect.value; // è·å–é€‰ä¸­çš„æ¨¡å‹
    if (key) {
        localStorage.setItem('zhipu_apikey', key);
        localStorage.setItem('zhipu_model', model); // ä¿å­˜æ¨¡å‹
        CONFIG.key = key;
        CONFIG.model = model;
        alert('é…ç½®å·²ä¿å­˜ï¼å½“å‰æ¨¡å‹ï¼š' + model);
        toggleConfig();
        updateStatus();
    }
}

function updateStatus() {
    const isConn = !!CONFIG.key;
    dom.status.innerHTML = isConn 
        ? `<i class="bi bi-circle-fill text-success me-1" style="font-size: 8px;"></i>å·²è¿æ¥ (${CONFIG.model})`
        : `<i class="bi bi-circle-fill text-secondary me-1" style="font-size: 8px;"></i>ç­‰å¾…é…ç½®`;
}

function clearChat() {
    dom.msgList.innerHTML = '';
}
</script>
{% endblock %}