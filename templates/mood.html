<!-- templates/mood.html - æŸ”å’Œç¿»é¡µç‰ˆæœ¬ -->
{% extends "base.html" %}

{% block title %}å¿ƒæƒ…è®°å½• - CampusPulse{% endblock %}

{% block extra_css %}
<style>
    /* å¿ƒæƒ…é€‰æ‹©å™¨æ ·å¼ */
    .mood-selector {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin: 2rem 0;
    }
    
    .mood-option {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid transparent;
        background: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .mood-option:hover {
        transform: translateY(-5px) scale(1.1);
    }
    
    .mood-option.selected {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    
    .mood-emoji {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .mood-1 .mood-emoji { color: #ef4444; }
    .mood-2 .mood-emoji { color: #f59e0b; }
    .mood-3 .mood-emoji { color: #64748b; }
    .mood-4 .mood-emoji { color: #10b981; }
    .mood-5 .mood-emoji { color: #3b82f6; }
    
    /* å¿ƒæƒ…æ—¶é—´çº¿æ ·å¼ */
    .mood-timeline {
        position: relative;
        padding-left: 2rem;
    }
    
    .mood-timeline::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(to bottom, var(--primary), var(--secondary));
        border-radius: 3px;
    }
    
    .mood-entry {
        position: relative;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
    }
    
    .mood-entry:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow);
    }
    
    .mood-entry::before {
        content: '';
        position: absolute;
        left: -2.4rem;
        top: 2rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--primary);
        border: 3px solid white;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    
    /* å¿ƒæƒ…å›¾è¡¨æ ·å¼ */
    .mood-chart {
        height: 200px;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        border-radius: var(--radius);
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
    }
    
    .insight-card {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(52, 211, 153, 0.1) 100%);
        border: 1px solid rgba(16, 185, 129, 0.2);
        border-radius: var(--radius);
        padding: 1.5rem;
    }
    
    /* ä¹¦ç±å¡ç‰‡æ ·å¼ */
    .quote-card {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: none;
        border-radius: var(--radius);
        padding: 1.5rem;
        position: relative;
        box-shadow: 
            0 4px 6px -1px rgba(0, 0, 0, 0.05),
            0 10px 15px -3px rgba(0, 0, 0, 0.08);
        min-height: 200px;
        overflow: hidden;
    }
    
    .quote-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(to bottom, var(--primary), var(--secondary));
        border-radius: var(--radius) 0 0 var(--radius);
    }
    
    /* æŸ”å’Œç¿»é¡µå®¹å™¨ */
    .flip-container {
        perspective: 1000px;
        min-height: 180px;
        position: relative;
        cursor: pointer;
    }
    
    .flip-page {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform-style: preserve-3d;
        backface-visibility: hidden;
        transition: transform 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        transform-origin: right center;
        border-radius: 4px;
        overflow: hidden;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        box-shadow: 
            0 2px 4px rgba(0, 0, 0, 0.05),
            0 1px 2px rgba(0, 0, 0, 0.03);
    }
    
    .flip-page.front {
        z-index: 2;
        transform: rotateY(0deg);
    }
    
    .flip-page.back {
        z-index: 1;
        transform: rotateY(180deg);
    }
    
    .flip-page.flipping {
        z-index: 3;
    }
    
    .page-content {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 1rem;
        position: relative;
    }
    
    .quote-text {
        font-family: 'Georgia', 'Times New Roman', serif;
        font-size: 1.1rem;
        line-height: 1.7;
        color: #334155;
        margin-bottom: 1.2rem;
        font-style: italic;
        text-align: justify;
        padding-right: 10px;
        position: relative;
    }
    
    .quote-text::before {
        content: '"';
        position: absolute;
        left: -10px;
        top: -10px;
        font-size: 2.5rem;
        color: var(--primary);
        opacity: 0.2;
        font-family: 'Georgia', serif;
    }
    
    .quote-text::after {
        content: '"';
        position: absolute;
        right: 5px;
        bottom: -15px;
        font-size: 2.5rem;
        color: var(--primary);
        opacity: 0.2;
        font-family: 'Georgia', serif;
    }
    
    .quote-author {
        font-family: 'Inter', sans-serif;
        font-size: 0.85rem;
        color: #64748b;
        text-align: right;
        font-weight: 500;
        padding-top: 0.8rem;
        margin-top: 0.8rem;
        border-top: 1px solid rgba(99, 102, 241, 0.1);
    }
    
    /* ç¿»é¡µæŒ‡ç¤ºå™¨ */
    .page-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-top: 1rem;
    }
    
    .page-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #e2e8f0;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .page-dot.active {
        background: var(--primary);
        transform: scale(1.2);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    
    .page-dot:hover {
        background: var(--primary);
    }
    
    /* å¯¼èˆªæŒ‰é’® */
    .flip-nav {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        margin-top: 1.5rem;
    }
    
    .flip-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid var(--gray-light);
        background: white;
        color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 1.2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .flip-btn:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
    }
    
    .flip-btn:active {
        transform: translateY(0);
    }
    
    .flip-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }
    
    .flip-btn:disabled:hover {
        background: white;
        color: var(--primary);
        border-color: var(--gray-light);
    }
    
    /* é¡µé¢è£…é¥° */
    .page-decoration {
        position: absolute;
        bottom: 1rem;
        right: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        opacity: 0.5;
    }
    
    .page-line {
        width: 30px;
        height: 1px;
        background: var(--gray-light);
    }
    
    .page-number {
        font-size: 0.75rem;
        color: var(--gray);
        font-family: 'Courier New', monospace;
    }
    
    /* æ·¡å…¥æ·¡å‡ºåŠ¨ç”» */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }
    
    /* å…¶ä»–æ ·å¼ */
    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
        color: var(--gray);
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .char-count {
        font-size: 0.85rem;
    }
    
    .char-count.limit {
        color: var(--danger);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- å·¦ä¾§ï¼šå¿ƒæƒ…è®°å½• -->
    <div class="col-lg-8">
        <div class="card mb-4 hover-lift">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-1">
                            <i class="bi bi-emoji-smile text-primary me-2"></i>è®°å½•ä»Šæ—¥å¿ƒæƒ…
                        </h5>
                        <p class="text-muted small mb-0">
                            {% if today_mood %}
                                âœ… ä»Šæ—¥å·²è®°å½• {{ today_mood.mood_score }}/5 åˆ†
                            {% else %}
                                ğŸ“ è®°å½•å¿ƒæƒ…æœ‰åŠ©äºè¿½è¸ªæƒ…ç»ªå˜åŒ–
                            {% endif %}
                        </p>
                    </div>
                    {% if today_mood %}
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle me-1"></i>å·²è®°å½•
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <form action="{{ url_for('log_mood') }}" method="POST" id="moodForm">
                    <!-- å¿ƒæƒ…é€‰æ‹©å™¨ -->
                    <div class="mood-selector">
                        {% for i in range(1, 6) %}
                        <div class="mood-option mood-{{ i }}" data-score="{{ i }}">
                            <div class="mood-emoji">
                                {{ ['ğŸ˜', 'ğŸ˜•', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š'][i-1] }}
                            </div>
                            <small class="fw-semibold">{{ i }}åˆ†</small>
                        </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="mood_score" id="selectedMood" value="3" required>
                    
                    <!-- å¿ƒæƒ…æè¿° -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-pencil me-2"></i>å¿ƒæƒ…æè¿°ï¼ˆå¯é€‰ï¼‰
                        </label>
                        <textarea class="form-control" name="note" rows="4" 
                                  placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç‰¹åˆ«çš„æ„Ÿå—æƒ³è®°å½•å—ï¼Ÿå¯ä»¥å†™ä¸‹å…·ä½“çš„äº‹æƒ…ã€æƒ³æ³•æˆ–æ„Ÿå—..."
                                  id="moodNote"></textarea>
                        <div class="text-end mt-2">
                            <small class="char-count text-muted" id="charCount">0/200 å­—</small>
                        </div>
                    </div>
                    
                    <!-- å¿«é€Ÿæ ‡ç­¾ -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold mb-2">
                            <i class="bi bi-tags me-2"></i>å¿«é€Ÿæ ‡ç­¾
                        </label>
                        <div class="d-flex flex-wrap gap-2" id="quickTags">
                            <button type="button" class="btn btn-sm btn-outline-primary tag-btn">
                                ğŸ˜Š å¼€å¿ƒ
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary tag-btn">
                                ğŸ“š å­¦ä¹ è¿›æ­¥
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary tag-btn">
                                ğŸƒ è¿åŠ¨
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary tag-btn">
                                ğŸµ å¬éŸ³ä¹
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary tag-btn">
                                ğŸœ ç¾é£Ÿ
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary tag-btn">
                                ğŸ˜´ ä¼‘æ¯
                            </button>
                        </div>
                    </div>
                    
                    <!-- æäº¤æŒ‰é’® -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary hover-lift" id="cancelBtn">
                            <i class="bi bi-x-circle me-1"></i>å–æ¶ˆ
                        </button>
                        <button type="submit" class="btn btn-primary hover-lift">
                            <i class="bi bi-save me-1"></i>
                            {% if today_mood %}æ›´æ–°å¿ƒæƒ…è®°å½•{% else %}ä¿å­˜å¿ƒæƒ…è®°å½•{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- å¿ƒæƒ…å†å² -->
        <div class="card hover-lift">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-heart text-primary me-2"></i>å¿ƒæƒ…å†å²è®°å½•
                </h5>
            </div>
            <div class="card-body">
                {% if moods %}
                <div class="mood-timeline">
                    {% for mood in moods[:10] %}
                    <div class="mood-entry fade-in">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="badge mood-{{ mood.mood_score }} mb-2">
                                    {{ ['ğŸ˜', 'ğŸ˜•', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š'][mood.mood_score - 1] }}
                                    {{ mood.mood_score }}/5 åˆ†
                                </span>
                                <h6 class="mb-1">{{ mood.created_at.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}</h6>
                            </div>
                            <small class="text-muted">{{ mood.created_at.strftime('%m-%d %H:%M') }}</small>
                        </div>
                        {% if mood.note %}
                        <p class="mb-0">{{ mood.note }}</p>
                        {% else %}
                        <p class="text-muted fst-italic mb-0">æ— é™„åŠ æè¿°</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                
                {% if moods|length > 10 %}
                <div class="text-center mt-4">
                    <a href="#" class="btn btn-outline-primary hover-lift">
                        <i class="bi bi-clock-history me-1"></i>æŸ¥çœ‹å…¨éƒ¨è®°å½• ({{ moods|length }})
                    </a>
                </div>
                {% endif %}
                
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-calendar"></i>
                    <h6 class="mt-3">æš‚æ— å¿ƒæƒ…è®°å½•</h6>
                    <p class="text-muted small">å¼€å§‹è®°å½•ä½ çš„ç¬¬ä¸€ä»½å¿ƒæƒ…å§ï¼</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- å³ä¾§ï¼šç»Ÿè®¡å’Œæ´å¯Ÿ -->
    <div class="col-lg-4">
        <!-- å¿ƒæƒ…ç»Ÿè®¡ -->
        <div class="card mb-4 hover-lift">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up text-primary me-2"></i>å¿ƒæƒ…ç»Ÿè®¡
                </h5>
            </div>
            <div class="card-body">
                <!-- ç®€å•çš„å¿ƒæƒ…å›¾è¡¨ -->
                <div class="mood-chart d-flex align-items-end justify-content-around mb-4">
                    {% for i in range(7) %}
                    <div class="chart-bar" style="width: 40px; height: {{ [60,80,40,100,60,80,40][i] }}px; 
                         background: linear-gradient(to top, var(--primary), var(--secondary));
                         border-radius: 8px 8px 0 0;"></div>
                    {% endfor %}
                </div>
                
                <div class="row text-center">
                    <div class="col-6">
                        <div class="p-3">
                            <h3 class="mb-1 text-primary">
                                {% if moods %}
                                    {{ (moods|map(attribute='mood_score')|sum / moods|length)|round(1) }}
                                {% else %}
                                    0.0
                                {% endif %}
                            </h3>
                            <small class="text-muted">å¹³å‡åˆ†</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3">
                            <h3 class="mb-1 text-success">{{ moods|length }}</h3>
                            <small class="text-muted">æ€»è®°å½•</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å¿ƒæƒ…æ´å¯Ÿ -->
        <div class="card mb-4 hover-lift insight-card">
            <div class="card-body">
                <h6 class="mb-3">
                    <i class="bi bi-lightbulb text-success me-2"></i>ä»Šæ—¥æ´å¯Ÿ
                </h6>
                {% if today_mood %}
                    {% if today_mood.mood_score >= 4 %}
                    <p class="mb-0">ä½ çš„å¿ƒæƒ…å¾ˆå¥½ï¼ç»§ç»­ä¿æŒè¿™ç§ç§¯æçŠ¶æ€ï¼Œå¯ä»¥å°è¯•åˆ†äº«ä½ çš„å¥½å¿ƒæƒ…æˆ–å¸®åŠ©ä»–äººã€‚</p>
                    {% elif today_mood.mood_score == 3 %}
                    <p class="mb-0">çŠ¶æ€å¹³ç¨³ã€‚å»ºè®®è§„åˆ’ä¸€äº›å°ç›®æ ‡ï¼Œå®Œæˆåç»™è‡ªå·±ä¸€äº›å¥–åŠ±ã€‚</p>
                    {% else %}
                    <p class="mb-0">å¯ä»¥å°è¯•å¬å¬éŸ³ä¹ã€çŸ­æš‚ä¼‘æ¯æˆ–ä¸æœ‹å‹èŠèŠå¤©æ¥è°ƒæ•´å¿ƒæƒ…ã€‚</p>
                    {% endif %}
                {% else %}
                <p class="mb-0">è®°å½•å¿ƒæƒ…åï¼Œç³»ç»Ÿä¼šä¸ºä½ æä¾›ä¸ªæ€§åŒ–çš„æƒ…ç»ªè°ƒèŠ‚å»ºè®®ã€‚</p>
                {% endif %}
            </div>
        </div>
        
        <!-- æŸ”å’Œç¿»é¡µè¯­å½• -->
        <div class="card hover-lift quote-card">
            <div class="card-header bg-white border-0">
                <h5 class="card-title mb-0">
                    <i class="bi bi-chat-quote text-primary me-2"></i>æ¯æ—¥ä¸€å¥
                </h5>
            </div>
            <div class="card-body">
                <div class="flip-container" id="flipContainer">
                    <div class="flip-page front" id="currentPage">
                        <div class="page-content">
                            <div class="quote-text" id="currentQuoteText">
                                "å…³æ³¨æƒ…ç»ªå˜åŒ–æ˜¯è‡ªæˆ‘æˆé•¿çš„é‡è¦ä¸€æ­¥ã€‚æ¯ä¸€å¤©çš„å¿ƒæƒ…éƒ½å€¼å¾—è¢«è®°å½•å’Œå°Šé‡ã€‚"
                            </div>
                            <div class="quote-author" id="currentQuoteAuthor">
                                â€” å¿ƒç†å¥åº·ä¸“å®¶
                            </div>
                            <div class="page-decoration">
                                <div class="page-line"></div>
                                <span class="page-number" id="currentPageNumber">1</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flip-page back" id="nextPage">
                        <div class="page-content">
                            <div class="quote-text" id="nextQuoteText">
                                "å­¦ä¹ æ˜¯ä¸€åœºé©¬æ‹‰æ¾ï¼Œä¸æ˜¯ç™¾ç±³å†²åˆºã€‚ä¿æŒç¨³å®šèŠ‚å¥ï¼Œæ‰èƒ½èµ°å¾—æ›´è¿œã€‚"
                            </div>
                            <div class="quote-author" id="nextQuoteAuthor">
                                â€” å­¦ä¹ è§„åˆ’å¸ˆ
                            </div>
                            <div class="page-decoration">
                                <div class="page-line"></div>
                                <span class="page-number" id="nextPageNumber">2</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç¿»é¡µå¯¼èˆª -->
                <div class="flip-nav">
                    <button class="flip-btn" id="prevBtn" title="ä¸Šä¸€å¥">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    
                    <div class="page-indicator" id="pageIndicator">
                        <!-- æŒ‡ç¤ºç‚¹å°†ç”±JavaScriptç”Ÿæˆ -->
                    </div>
                    
                    <button class="flip-btn" id="nextBtn" title="ä¸‹ä¸€å¥">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- å¿«é€Ÿæç¤º -->
        <div class="mt-4">
            <h6 class="mb-3">
                <i class="bi bi-info-circle text-info me-2"></i>å°è´´å£«
            </h6>
            <ul class="list-unstyled small">
                <li class="mb-2">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    æ¯å¤©è®°å½•å¿ƒæƒ…æœ‰åŠ©äºæƒ…ç»ªç®¡ç†
                </li>
                <li class="mb-2">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    æƒ…ç»ªä½è½æ—¶ï¼Œå°è¯•æ·±å‘¼å¸æˆ–çŸ­æš‚ä¼‘æ¯
                </li>
                <li class="mb-2">
                    <i class="bi bi-check-circle text-success me-2"></i>
                    ä¸æœ‹å‹åˆ†äº«æ„Ÿå—å¯ä»¥ç¼“è§£å‹åŠ›
                </li>
                <li>
                    <i class="bi bi-check-circle text-success me-2"></i>
                    è§„å¾‹ä½œæ¯å’Œé€‚åº¦è¿åŠ¨å¯¹æƒ…ç»ªæœ‰ç›Š
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // å¿ƒæƒ…é€‰æ‹©å™¨
    let selectedMood = 3;
    $('.mood-option').click(function() {
        $('.mood-option').removeClass('selected');
        $(this).addClass('selected');
        selectedMood = $(this).data('score');
        $('#selectedMood').val(selectedMood);
    });
    
    // åˆå§‹åŒ–é€‰æ‹©ç¬¬ä¸‰ä¸ªå¿ƒæƒ…
    $('.mood-option').eq(2).addClass('selected');
    
    // å­—ç¬¦è®¡æ•°
    $('#moodNote').on('input', function() {
        const length = $(this).val().length;
        const charCount = $('#charCount');
        charCount.text(`${length}/200 å­—`);
        
        if (length > 200) {
            $(this).val($(this).val().substring(0, 200));
            charCount.text('200/200 å­—').addClass('limit');
        } else {
            charCount.removeClass('limit');
        }
    });
    
    // å¿«é€Ÿæ ‡ç­¾
    $('.tag-btn').click(function() {
        const tag = $(this).text().trim();
        const textarea = $('#moodNote');
        const currentText = textarea.val();
        
        if (currentText.length + tag.length + 1 <= 200) {
            if (currentText) {
                textarea.val(currentText + ' ' + tag);
            } else {
                textarea.val(tag);
            }
            
            // æ›´æ–°å­—ç¬¦è®¡æ•°
            $('#moodNote').trigger('input');
            
            // æŒ‰é’®åé¦ˆ
            $(this).removeClass('btn-outline-primary').addClass('btn-primary');
            setTimeout(() => {
                $(this).removeClass('btn-primary').addClass('btn-outline-primary');
            }, 500);
        } else {
            showToast('å·²è¾¾åˆ°å­—æ•°é™åˆ¶', 'warning');
        }
    });
    
    // å–æ¶ˆæŒ‰é’®
    $('#cancelBtn').click(function() {
        if ($('#moodNote').val() || selectedMood !== 3) {
            showConfirm(
                'ç¡®å®šè¦å–æ¶ˆå—ï¼Ÿå·²å¡«å†™çš„å†…å®¹å°†ä¸¢å¤±ã€‚',
                'ç¡®è®¤å–æ¶ˆ'
            ).then((confirmed) => {
                if (confirmed) {
                    window.location.href = "{{ url_for('dashboard') }}";
                }
            });
        } else {
            window.location.href = "{{ url_for('dashboard') }}";
        }
    });
    
    // è¡¨å•æäº¤
    $('#moodForm').submit(function(e) {
        e.preventDefault();
        
        // ç®€å•éªŒè¯
        if (!selectedMood) {
            showToast('è¯·é€‰æ‹©ä¸€ä¸ªå¿ƒæƒ…è¯„åˆ†', 'warning');
            return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="bi bi-hourglass-split me-1"></i>ä¿å­˜ä¸­...');
        
        // æ¨¡æ‹Ÿå»¶è¿Ÿåæäº¤
        setTimeout(() => {
            this.submit();
        }, 800);
    });
    
    // ========== æŸ”å’Œç¿»é¡µè¯­å½•ç³»ç»Ÿ ==========
    
    // è¯­å½•æ•°æ®åº“
    const quotesDatabase = [
        {
            text: "å…³æ³¨æƒ…ç»ªå˜åŒ–æ˜¯è‡ªæˆ‘æˆé•¿çš„é‡è¦ä¸€æ­¥ã€‚æ¯ä¸€å¤©çš„å¿ƒæƒ…éƒ½å€¼å¾—è¢«è®°å½•å’Œå°Šé‡ã€‚",
            author: "å¿ƒç†å¥åº·ä¸“å®¶"
        },
        {
            text: "å­¦ä¹ æ˜¯ä¸€åœºé©¬æ‹‰æ¾ï¼Œä¸æ˜¯ç™¾ç±³å†²åˆºã€‚ä¿æŒç¨³å®šèŠ‚å¥ï¼Œæ‰èƒ½èµ°å¾—æ›´è¿œã€‚",
            author: "å­¦ä¹ è§„åˆ’å¸ˆ"
        },
        {
            text: "çœŸæ­£çš„è¿›æ­¥æ¥è‡ªäºå¾®å°çš„ã€æŒç»­çš„æ”¹å˜ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§çš„å·¨å¤§åŠªåŠ›ã€‚",
            author: "æ•ˆç‡ä¸“å®¶"
        },
        {
            text: "æƒ…ç»ªå¦‚å¤©æ°”ï¼Œé˜´æ™´åœ†ç¼ºçš†æ˜¯è‡ªç„¶ã€‚æ¥çº³è‡ªå·±çš„æ¯ä¸€ç§çŠ¶æ€ã€‚",
            author: "å¿ƒç†å­¦æ•™æˆ"
        },
        {
            text: "æ¯ä¸€æ¬¡çš„æƒ…ç»ªè®°å½•ï¼Œéƒ½æ˜¯ä¸å†…å¿ƒçš„ä¸€æ¬¡çœŸè¯šå¯¹è¯ã€‚",
            author: "æƒ…ç»ªç®¡ç†å¸ˆ"
        },
        {
            text: "å­¦ä¹ ä¸åªæ˜¯ç§¯ç´¯çŸ¥è¯†ï¼Œæ›´æ˜¯åŸ¹å…»é¢å¯¹å›°éš¾æ—¶çš„éŸ§æ€§ã€‚",
            author: "æ•™è‚²å­¦å®¶"
        },
        {
            text: "ä¼‘æ¯ä¸æ˜¯æµªè´¹æ—¶é—´ï¼Œè€Œæ˜¯ä¸ºäº†æ›´é«˜è´¨é‡çš„æŠ•å…¥ã€‚",
            author: "ç²¾åŠ›ç®¡ç†ä¸“å®¶"
        },
        {
            text: "ä»Šå¤©çš„æ¯ä¸€æ­¥åŠªåŠ›ï¼Œéƒ½åœ¨ä¸ºæ˜å¤©çš„æˆåŠŸé“ºè·¯ã€‚",
            author: "æˆé•¿å¯¼å¸ˆ"
        },
        {
            text: "ä¿æŒå¥½å¥‡å¿ƒï¼Œä¿æŒæ±‚çŸ¥æ¬²ï¼Œå­¦ä¹ çš„è·¯ä¸Šæ°¸ä¸å­¤å•ã€‚",
            author: "ç»ˆèº«å­¦ä¹ è€…"
        },
        {
            text: "è®°å½•å¿ƒæƒ…ä¸ä»…æ˜¯å›é¡¾è¿‡å»ï¼Œæ›´æ˜¯ä¸ºäº†æ›´å¥½åœ°è§„åˆ’æœªæ¥ã€‚",
            author: "ç”Ÿæ´»è§„åˆ’å¸ˆ"
        },
        {
            text: "æ¯ä¸€æ¬¡æ·±å‘¼å¸ï¼Œéƒ½æ˜¯ç»™å¿ƒçµçš„ä¸€æ¬¡æ¸©æŸ”æ‹¥æŠ±ã€‚",
            author: "æ­£å¿µå¯¼å¸ˆ"
        },
        {
            text: "å›°éš¾åƒå¼¹ç°§ï¼Œä½ å¼±å®ƒå°±å¼ºã€‚ä¿æŒç§¯æå¿ƒæ€ï¼Œå›°éš¾è‡ªä¼šé€€è®©ã€‚",
            author: "å¿ƒæ€æ•™ç»ƒ"
        },
        {
            text: "å­¦ä¹ å¦‚ç™»å±±ï¼Œæ¯ä¸€æ­¥è™½å°ï¼Œä½†ç¦»å±±é¡¶æ›´è¿‘ä¸€æ­¥ã€‚",
            author: "ç™»å±±çˆ±å¥½è€…"
        }
    ];
    
    // å½“å‰çŠ¶æ€
    let currentIndex = 0;
    let isAnimating = false;
    let autoPlayInterval = null;
    
    // åˆå§‹åŒ–è¯­å½•ç³»ç»Ÿ
    function initQuotes() {
        updatePageContent();
        createPageIndicators();
        startAutoPlay();
        
        // ç‚¹å‡»å¡ç‰‡ä¹Ÿå¯ä»¥ç¿»é¡µ
        $('#flipContainer').click(function(e) {
            if (!$(e.target).closest('.flip-btn').length) {
                nextQuote();
            }
        });
    }
    
    // åˆ›å»ºé¡µé¢æŒ‡ç¤ºç‚¹
    function createPageIndicators() {
        const container = $('#pageIndicator');
        container.empty();
        
        for (let i = 0; i < quotesDatabase.length; i++) {
            const dot = $('<div class="page-dot"></div>');
            if (i === currentIndex) {
                dot.addClass('active');
            }
            dot.data('index', i);
            container.append(dot);
        }
    }
    
    // æ›´æ–°é¡µé¢å†…å®¹
    function updatePageContent() {
        const currentQuote = quotesDatabase[currentIndex];
        const nextIndex = (currentIndex + 1) % quotesDatabase.length;
        const nextQuote = quotesDatabase[nextIndex];
        
        // æ›´æ–°å½“å‰é¡µ
        $('#currentQuoteText').text(`"${currentQuote.text}"`);
        $('#currentQuoteAuthor').text(`â€” ${currentQuote.author}`);
        $('#currentPageNumber').text(currentIndex + 1);
        
        // æ›´æ–°ä¸‹ä¸€é¡µï¼ˆèƒŒé¢ï¼‰
        $('#nextQuoteText').text(`"${nextQuote.text}"`);
        $('#nextQuoteAuthor').text(`â€” ${nextQuote.author}`);
        $('#nextPageNumber').text(nextIndex + 1);
        
        // æ›´æ–°æŒ‡ç¤ºç‚¹
        $('.page-dot').removeClass('active');
        $(`.page-dot[data-index="${currentIndex}"]`).addClass('active');
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateButtonStates();
    }
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    function updateButtonStates() {
        $('#prevBtn').prop('disabled', false);
        $('#nextBtn').prop('disabled', false);
    }
    
    // ä¸‹ä¸€å¥è¯­å½•
    function nextQuote() {
        if (isAnimating) return;
        
        isAnimating = true;
        const currentPage = $('#currentPage');
        const nextPage = $('#nextPage');
        
        // é‡ç½®é¡µé¢çŠ¶æ€
        currentPage.removeClass('front').addClass('flipping');
        nextPage.removeClass('back').addClass('front');
        
        // æ‰§è¡Œç¿»é¡µåŠ¨ç”»
        currentPage.css('transform', 'rotateY(-180deg)');
        
        // åŠ¨ç”»å®Œæˆåæ›´æ–°å†…å®¹
        setTimeout(() => {
            // æ›´æ–°ç´¢å¼•
            currentIndex = (currentIndex + 1) % quotesDatabase.length;
            
            // é‡ç½®é¡µé¢ä½ç½®
            currentPage.removeClass('flipping').addClass('back');
            nextPage.removeClass('front').addClass('back');
            
            // é‡ç½®transform
            currentPage.css('transform', 'rotateY(180deg)');
            nextPage.css('transform', 'rotateY(0deg)');
            
            // äº¤æ¢é¡µé¢ID
            currentPage.attr('id', 'nextPage');
            nextPage.attr('id', 'currentPage');
            
            // æ›´æ–°å†…å®¹
            updatePageContent();
            isAnimating = false;
            
            // é‡ç½®è‡ªåŠ¨æ’­æ”¾è®¡æ—¶
            resetAutoPlay();
        }, 1200);
    }
    
    // ä¸Šä¸€å¥è¯­å½•
    function prevQuote() {
        if (isAnimating) return;
        
        isAnimating = true;
        const currentPage = $('#currentPage');
        const nextPage = $('#nextPage');
        
        // é¢„å…ˆæ›´æ–°ç´¢å¼•
        currentIndex = (currentIndex - 1 + quotesDatabase.length) % quotesDatabase.length;
        const prevIndex = (currentIndex - 1 + quotesDatabase.length) % quotesDatabase.length;
        const prevQuote = quotesDatabase[prevIndex];
        
        // ä¸´æ—¶è®¾ç½®å‰ä¸€é¡µå†…å®¹
        nextPage.find('.quote-text').text(`"${prevQuote.text}"`);
        nextPage.find('.quote-author').text(`â€” ${prevQuote.author}`);
        nextPage.find('.page-number').text(prevIndex + 1);
        
        // äº¤æ¢é¡µé¢ä½ç½®ï¼ˆä½¿ç”¨åå‘åŠ¨ç”»ï¼‰
        currentPage.removeClass('front').addClass('back');
        nextPage.removeClass('back').addClass('front');
        
        nextPage.css('transform', 'rotateY(180deg)');
        
        // æ‰§è¡Œåå‘ç¿»é¡µåŠ¨ç”»
        setTimeout(() => {
            nextPage.css('transform', 'rotateY(0deg)');
            
            // åŠ¨ç”»å®Œæˆåäº¤æ¢é¡µé¢ID
            setTimeout(() => {
                currentPage.attr('id', 'nextPage');
                nextPage.attr('id', 'currentPage');
                
                // æ›´æ–°å†…å®¹
                updatePageContent();
                isAnimating = false;
                
                // é‡ç½®è‡ªåŠ¨æ’­æ”¾è®¡æ—¶
                resetAutoPlay();
            }, 600);
        }, 50);
    }
    
    // è·³è½¬åˆ°æŒ‡å®šè¯­å½•
    function gotoQuote(index) {
        if (isAnimating || index === currentIndex) return;
        
        // åˆ¤æ–­æ–¹å‘
        if (index > currentIndex) {
            // å‘å‰ç¿»é¡µ
            currentIndex = index;
            nextQuote();
        } else {
            // å‘åç¿»é¡µ
            currentIndex = index;
            prevQuote();
        }
    }
    
    // è‡ªåŠ¨æ’­æ”¾
    function startAutoPlay() {
        if (autoPlayInterval) clearInterval(autoPlayInterval);
        autoPlayInterval = setInterval(() => {
            nextQuote();
        }, 10000); // 10ç§’è‡ªåŠ¨åˆ‡æ¢
    }
    
    function resetAutoPlay() {
        startAutoPlay();
    }
    
    // äº‹ä»¶ç»‘å®š
    $('#nextBtn').click(nextQuote);
    $('#prevBtn').click(prevQuote);
    
    // æŒ‡ç¤ºç‚¹ç‚¹å‡»
    $(document).on('click', '.page-dot', function() {
        const index = $(this).data('index');
        gotoQuote(index);
    });
    
    // é”®ç›˜å¯¼èˆª
    $(document).keydown(function(e) {
        if ($('.quote-card').is(':visible')) {
            if (e.key === 'ArrowRight' || e.key === ' ') {
                nextQuote();
                e.preventDefault();
            } else if (e.key === 'ArrowLeft') {
                prevQuote();
                e.preventDefault();
            }
        }
    });
    
    // è§¦æ‘¸æ»‘åŠ¨æ”¯æŒ
    let touchStartX = 0;
    let touchEndX = 0;
    
    $('#flipContainer').on('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
        stopAutoPlay();
    });
    
    $('#flipContainer').on('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
        startAutoPlay();
    });
    
    function handleSwipe() {
        const swipeThreshold = 30;
        const diff = touchEndX - touchStartX;
        
        if (Math.abs(diff) > swipeThreshold) {
            if (diff > 0) {
                // å‘å³æ»‘åŠ¨ï¼Œä¸Šä¸€é¡µ
                prevQuote();
            } else {
                // å‘å·¦æ»‘åŠ¨ï¼Œä¸‹ä¸€é¡µ
                nextQuote();
            }
        }
    }
    
    function stopAutoPlay() {
        if (autoPlayInterval) {
            clearInterval(autoPlayInterval);
            autoPlayInterval = null;
        }
    }
    
    // é¼ æ ‡æ‚¬åœæ—¶æš‚åœè‡ªåŠ¨æ’­æ”¾
    $('.quote-card').hover(
        function() {
            stopAutoPlay();
        },
        function() {
            startAutoPlay();
        }
    );
    
    // åˆå§‹åŒ–
    initQuotes();
    
    // é¡µé¢åŠ è½½æ—¶å¦‚æœæœ‰ä»Šæ—¥å¿ƒæƒ…ï¼Œæ˜¾ç¤ºä¸ªæ€§åŒ–é—®å€™
    {% if today_mood %}
    setTimeout(() => {
        const score = {{ today_mood.mood_score }};
        const messages = {
            1: "çœ‹åˆ°ä½ ä»Šå¤©å¿ƒæƒ…ä¸å¤ªå¥½ï¼Œå¯ä»¥è¯•è¯•å¬å¬éŸ³ä¹æˆ–å‡ºå»èµ°èµ°ã€‚",
            2: "ä»Šå¤©å¥½åƒæœ‰ç‚¹å°çƒ¦æ¼ï¼Œå’Œæœ‹å‹èŠèŠä¼šå¥½å¾ˆå¤šå“¦ã€‚",
            3: "ä¿æŒå¹³å¸¸å¿ƒï¼Œç»™è‡ªå·±ä¸€ç‚¹å°å¥–åŠ±å§ï¼",
            4: "ä»Šå¤©å¿ƒæƒ…ä¸é”™ï¼ç»§ç»­ä¿æŒè¿™ç§ç§¯æçŠ¶æ€ï½",
            5: "å“‡ï¼ä»Šå¤©çŠ¶æ€å¾ˆæ£’ï¼å¯ä»¥æŒ‘æˆ˜ä¸€äº›æœ‰éš¾åº¦çš„ä»»åŠ¡ï¼"
        };
        
        if (messages[score]) {
            showToast(messages[score], 'info');
        }
    }, 3000);
    {% endif %}
});
</script>
{% endblock %}