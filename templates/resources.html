<!-- resources.html - 修复版（仅按钮触发搜索） -->
{% extends "base.html" %}

{% block title %}学习资源 - CampusPulse{% endblock %}

{% block extra_css %}
<style>
    /* 保持原有样式不变 */
    .resource-search {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
        border-radius: var(--radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(99, 102, 241, 0.1);
    }
    
    .resource-card {
        transition: var(--transition);
        height: 100%;
        border: 1px solid rgba(99, 102, 241, 0.1);
    }
    
    .resource-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow);
        border-color: var(--primary);
    }
    
    .resource-type-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 1;
    }
    
    .resource-cover {
        height: 120px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        border-radius: var(--radius) var(--radius) 0 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
    }
    
    .resource-content {
        padding: 1.5rem;
    }
    
    .resource-title {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 0.75rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .resource-desc {
        color: var(--gray);
        font-size: 0.875rem;
        margin-bottom: 1rem;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .resource-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .keyword-tag {
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .recommended-badge {
        position: absolute;
        top: -10px;
        left: 1rem;
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        z-index: 2;
        box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3);
    }
    
    .category-filter {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }
    
    .category-btn {
        padding: 0.5rem 1rem;
        border: 2px solid var(--gray-light);
        border-radius: 20px;
        background: white;
        color: var(--gray);
        font-weight: 500;
        transition: var(--transition);
        cursor: pointer;
    }
    
    .category-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
    }
    
    .category-btn.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }
    
    .empty-resources {
        padding: 4rem 2rem;
        text-align: center;
        color: var(--gray);
    }
    
    .empty-resources i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    
    .view-count {
        color: var(--gray);
        font-size: 0.875rem;
    }
    
    .ai-recommendation {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(167, 139, 250, 0.1) 100%);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: var(--radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .resource-count-badge {
        font-size: 0.85rem;
        padding: 0.3rem 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- 页面标题 -->
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-2">
                    <i class="bi bi-book text-primary me-2"></i>学习资源库
                </h1>
                <p class="text-muted mb-0">
                    <span class="badge bg-success resource-count-badge">{{ resources|length }} 个高质量资源</span>
                    <span class="ms-2">应用启动时自动加载</span>
                </p>
            </div>
            <button class="btn btn-primary hover-lift" data-bs-toggle="modal" data-bs-target="#addResourceModal">
                <i class="bi bi-plus-lg me-1"></i>分享资源
            </button>
        </div>
    </div>

    <!-- AI推荐说明 -->
    <div class="col-12">
        <div class="ai-recommendation">
            <div class="d-flex align-items-start">
                <div class="flex-shrink-0">
                    <i class="bi bi-robot text-primary fs-3"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h6 class="mb-2">
                        <span class="badge bg-primary me-2">AI推荐</span>
                        基于你的学习任务智能推荐
                    </h6>
                    <p class="mb-0 text-muted small">
                        {% if recommended %}
                        系统分析了你的任务内容，为你推荐以下相关学习资源。
                        {% else %}
                        还没有个性化推荐，请先添加一些学习任务。
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 搜索和筛选 -->
    <div class="col-12">
        <div class="resource-search">
            <div class="row g-3">
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="搜索学习资源...">
                        <button class="btn btn-outline-primary hover-lift" id="searchBtn" type="button">
                            搜索
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="sortResources">
                        <option value="recommended">智能推荐</option>
                        <option value="newest">最新添加</option>
                        <option value="title">名称排序</option>
                    </select>
                </div>
            </div>

            <!-- 分类筛选 -->
            <div class="category-filter mt-3">
                <div class="category-btn active" data-category="all">全部</div>
                {% for category, count in categories %}
                <div class="category-btn" data-category="{{ category }}">
                    {{ category }} <span class="badge bg-light text-dark ms-1">{{ count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- 推荐资源 -->
    {% if recommended %}
    <div class="col-12 mb-4">
        <h5 class="mb-3">
            <i class="bi bi-stars text-primary me-2"></i>为你推荐
            <small class="text-muted">基于你的学习任务匹配</small>
        </h5>
        <div class="row g-4" id="recommendedResources">
            {% for resource in recommended %}
            <div class="col-xl-4 col-lg-6 resource-item" 
                 data-category="{{ resource.resource_type }}"
                 data-title="{{ resource.title|lower }}"
                 data-keywords="{{ resource.keywords|lower if resource.keywords else '' }}">
                <div class="resource-card card position-relative">
                    <span class="recommended-badge">
                        <i class="bi bi-lightning-charge me-1"></i>AI推荐
                    </span>
                    <div class="resource-cover" style="background: linear-gradient(135deg, 
                            {% if resource.resource_type == 'Python编程' %}#3b82f6 0%, #1d4ed8 100%
                            {% elif resource.resource_type == 'Web开发' %}#8b5cf6 0%, #7c3aed 100%
                            {% elif resource.resource_type == '数据科学' %}#10b981 0%, #059669 100%
                            {% elif resource.resource_type == '机器学习' %}#f59e0b 0%, #d97706 100%
                            {% elif resource.resource_type == '学习方法' %}#ec4899 0%, #db2777 100%
                            {% elif resource.resource_type == '心理健康' %}#ef4444 0%, #dc2626 100%
                            {% elif resource.resource_type == 'Web框架' %}#14b8a6 0%, #0d9488 100%
                            {% elif resource.resource_type == '前端框架' %}#06b6d4 0%, #0891b2 100%
                            {% elif resource.resource_type == '开发工具' %}#8b5cf6 0%, #7c3aed 100%
                            {% elif resource.resource_type == '数据库' %}#f97316 0%, #ea580c 100%
                            {% elif resource.resource_type == '语言学习' %}#06b6d4 0%, #0891b2 100%
                            {% elif resource.resource_type == '写作技能' %}#84cc16 0%, #65a30d 100%
                            {% else %}#6366f1 0%, #4f46e5 100%{% endif %});">
                    </div>
                    <div class="resource-content">
                        <span class="resource-type-badge badge" style="background: 
                            {% if resource.resource_type == 'Python编程' %}#3b82f6
                            {% elif resource.resource_type == 'Web开发' %}#8b5cf6
                            {% elif resource.resource_type == '数据科学' %}#10b981
                            {% elif resource.resource_type == '机器学习' %}#f59e0b
                            {% elif resource.resource_type == '学习方法' %}#ec4899
                            {% elif resource.resource_type == '心理健康' %}#ef4444
                            {% else %}#6366f1{% endif %};">
                            {{ resource.resource_type }}
                        </span>
                        
                        <h6 class="resource-title">{{ resource.title }}</h6>
                        
                        {% if resource.description %}
                        <p class="resource-desc">{{ resource.description }}</p>
                        {% endif %}
                        
                        {% if resource.keywords %}
                        <div class="resource-keywords">
                            {% for keyword in resource.keywords.split(',')[:3] %}
                            <span class="keyword-tag">{{ keyword|trim }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="{{ resource.url }}" target="_blank" 
                               class="btn btn-outline-primary btn-sm hover-lift">
                                <i class="bi bi-box-arrow-up-right me-1"></i>访问资源
                            </a>
                            <small class="view-count">
                                <i class="bi bi-eye me-1"></i> {{ resource.views or 0 }}次查看
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- 所有资源 -->
    <div class="col-12">
        <h5 class="mb-3">
            <i class="bi bi-collection text-primary me-2"></i>所有资源
            <small class="text-muted">共 {{ resources|length }} 个高质量学习资源</small>
        </h5>
        
        {% if resources %}
        <div class="row g-4" id="allResources">
            {% for resource in resources %}
            {% if resource not in recommended or recommended|length == 0 %}
            <div class="col-xl-3 col-lg-4 col-md-6 resource-item" 
                 data-category="{{ resource.resource_type }}"
                 data-title="{{ resource.title|lower }}"
                 data-keywords="{{ resource.keywords|lower if resource.keywords else '' }}">
                <div class="resource-card card h-100">
                    <div class="resource-cover" style="background: linear-gradient(135deg, 
                        {% if resource.resource_type == 'Python编程' %}#3b82f6 0%, #1d4ed8 100%
                        {% elif resource.resource_type == 'Web开发' %}#8b5cf6 0%, #7c3aed 100%
                        {% elif resource.resource_type == '数据科学' %}#10b981 0%, #059669 100%
                        {% elif resource.resource_type == '机器学习' %}#f59e0b 0%, #d97706 100%
                        {% elif resource.resource_type == '学习方法' %}#ec4899 0%, #db2777 100%
                        {% elif resource.resource_type == '心理健康' %}#ef4444 0%, #dc2626 100%
                        {% elif resource.resource_type == 'Web框架' %}#14b8a6 0%, #0d9488 100%
                        {% elif resource.resource_type == '前端框架' %}#06b6d4 0%, #0891b2 100%
                        {% elif resource.resource_type == '开发工具' %}#8b5cf6 0%, #7c3aed 100%
                        {% elif resource.resource_type == '数据库' %}#f97316 0%, #ea580c 100%
                        {% elif resource.resource_type == '语言学习' %}#06b6d4 0%, #0891b2 100%
                        {% elif resource.resource_type == '写作技能' %}#84cc16 0%, #65a30d 100%
                        {% else %}#6366f1 0%, #4f46e5 100%{% endif %});">
                        <i class="bi bi-{{ 
                            'code-slash' if resource.resource_type == 'Python编程'
                            else 'globe' if resource.resource_type == 'Web开发'
                            else 'database' if resource.resource_type == '数据科学'
                            else 'robot' if resource.resource_type == '机器学习'
                            else 'book' if resource.resource_type == '学习方法'
                            else 'heart' if resource.resource_type == '心理健康'
                            else 'cpu' if resource.resource_type == 'Web框架'
                            else 'palette' if resource.resource_type == '前端框架'
                            else 'tools' if resource.resource_type == '开发工具'
                            else 'hdd' if resource.resource_type == '数据库'
                            else 'translate' if resource.resource_type == '语言学习'
                            else 'pen' if resource.resource_type == '写作技能'
                            else 'link'
                        }} text-white"></i>
                    </div>
                    <div class="resource-content">
                        <span class="resource-type-badge badge" style="background: 
                            {% if resource.resource_type == 'Python编程' %}#3b82f6
                            {% elif resource.resource_type == 'Web开发' %}#8b5cf6
                            {% elif resource.resource_type == '数据科学' %}#10b981
                            {% elif resource.resource_type == '机器学习' %}#f59e0b
                            {% elif resource.resource_type == '学习方法' %}#ec4899
                            {% elif resource.resource_type == '心理健康' %}#ef4444
                            {% elif resource.resource_type == 'Web框架' %}#14b8a6
                            {% elif resource.resource_type == '前端框架' %}#06b6d4
                            {% elif resource.resource_type == '开发工具' %}#8b5cf6
                            {% elif resource.resource_type == '数据库' %}#f97316
                            {% elif resource.resource_type == '语言学习' %}#06b6d4
                            {% elif resource.resource_type == '写作技能' %}#84cc16
                            {% else %}#6366f1{% endif %};">
                            {{ resource.resource_type }}
                        </span>
                        
                        <h6 class="resource-title">{{ resource.title }}</h6>
                        
                        {% if resource.description %}
                        <p class="resource-desc">{{ resource.description|truncate(100) }}</p>
                        {% endif %}
                        
                        {% if resource.keywords %}
                        <div class="resource-keywords">
                            {% for keyword in resource.keywords.split(',')[:3] %}
                            <span class="keyword-tag">{{ keyword|trim }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <a href="{{ resource.url }}" target="_blank" 
                               class="btn btn-outline-primary btn-sm hover-lift">
                                <i class="bi bi-box-arrow-up-right me-1"></i>访问
                            </a>
                            <small class="view-count">
                                <i class="bi bi-calendar3 me-1"></i>
                                {{ resource.created_at.strftime('%Y-%m-%d') if resource.created_at else '近期' }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        
        {% if resources|length == recommended|length and recommended|length > 0 %}
        <div class="empty-resources">
            <i class="bi bi-book"></i>
            <h6 class="mt-3">所有资源都在推荐列表中</h6>
            <p class="text-muted small">系统已经为你推荐了所有适合的学习资源</p>
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-resources">
            <i class="bi bi-book"></i>
            <h6 class="mt-3">暂无学习资源</h6>
            <p class="text-muted small">应用正在加载资源，请稍后刷新页面</p>
            <button class="btn btn-primary hover-lift mt-3" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise me-1"></i>刷新页面
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- 分享资源模态框 -->
<div class="modal fade" id="addResourceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title">
                    <i class="bi bi-share text-primary me-2"></i>分享学习资源
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addResourceForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">资源标题 *</label>
                        <input type="text" class="form-control" id="resourceTitle" required 
                               placeholder="例如：Python入门教程">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">资源描述</label>
                        <textarea class="form-control" id="resourceDesc" rows="3" 
                                  placeholder="简要描述这个资源的内容、特点或适用人群..."></textarea>
                        <div class="form-text">0/200 字</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">资源链接 *</label>
                        <input type="url" class="form-control" id="resourceUrl" required 
                               placeholder="https://example.com/learning-resource">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">资源类型 *</label>
                            <select class="form-select" id="resourceType" required>
                                <option value="">选择类型</option>
                                <option value="Python编程">Python编程</option>
                                <option value="Web开发">Web开发</option>
                                <option value="数据科学">数据科学</option>
                                <option value="机器学习">机器学习</option>
                                <option value="Web框架">Web框架</option>
                                <option value="前端框架">前端框架</option>
                                <option value="开发工具">开发工具</option>
                                <option value="数据库">数据库</option>
                                <option value="学习方法">学习方法</option>
                                <option value="时间管理">时间管理</option>
                                <option value="心理健康">心理健康</option>
                                <option value="语言学习">语言学习</option>
                                <option value="写作技能">写作技能</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">关键词</label>
                            <input type="text" class="form-control" id="resourceKeywords" 
                                   placeholder="python,编程,入门 (用逗号分隔)">
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary hover-lift" data-bs-dismiss="modal">
                        取消
                    </button>
                    <button type="submit" class="btn btn-primary hover-lift" id="submitResourceBtn">
                        分享资源
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 更新资源计数显示
    function updateResourceCount() {
        const visibleCount = $('.resource-item:visible').length;
        const totalCount = {{ resources|length }};
        $('.resource-count-badge').text(`${visibleCount}/${totalCount} 个资源`);
    }
    
    updateResourceCount();

    // 【修复点】移除自动搜索，只保留按钮点击搜索
    // 资源搜索 - 仅通过按钮触发
    $('#searchBtn').click(function() {
        const searchText = $('#searchInput').val().toLowerCase();
        const selectedCategory = $('.category-btn.active').data('category');
        
        $('.resource-item').each(function() {
            const $item = $(this);
            const title = $item.data('title');
            const keywords = $item.data('keywords');
            const category = $item.data('category');
            
            let show = true;
            
            // 分类筛选
            if (selectedCategory !== 'all' && category !== selectedCategory) {
                show = false;
            }
            
            // 搜索筛选
            if (searchText) {
                const inTitle = title.includes(searchText);
                const inKeywords = keywords.includes(searchText);
                
                if (!inTitle && !inKeywords) {
                    show = false;
                }
            }
            
            $item.toggle(show);
        });
        
        updateResourceCount();
        
        // 如果没有搜索结果
        const visibleCount = $('.resource-item:visible').length;
        if (visibleCount === 0 && searchText) {
            showAlert(`没有找到包含"${searchText}"的资源`, '搜索结果');
        }
    });
    
    // 分类筛选
    $('.category-btn').click(function() {
        $('.category-btn').removeClass('active');
        $(this).addClass('active');
        filterResources();
    });
    
    // 排序
    $('#sortResources').change(function() {
        sortResources($(this).val());
    });
    
    // 资源筛选函数
    function filterResources() {
        const searchText = $('#searchInput').val().toLowerCase();
        const selectedCategory = $('.category-btn.active').data('category');
        
        $('.resource-item').each(function() {
            const $item = $(this);
            const title = $item.data('title');
            const keywords = $item.data('keywords');
            const category = $item.data('category');
            
            let show = true;
            
            // 分类筛选
            if (selectedCategory !== 'all' && category !== selectedCategory) {
                show = false;
            }
            
            // 搜索筛选
            if (searchText) {
                const inTitle = title.includes(searchText);
                const inKeywords = keywords.includes(searchText);
                
                if (!inTitle && !inKeywords) {
                    show = false;
                }
            }
            
            $item.toggle(show);
        });
        
        updateResourceCount();
        
        // 如果没有搜索结果
        const visibleCount = $('.resource-item:visible').length;
        if (visibleCount === 0 && searchText) {
            showAlert(`没有找到包含"${searchText}"的资源`, '搜索结果');
        }
    }
    
    // 资源排序函数
    function sortResources(sortBy) {
        const $container = $('#allResources');
        const items = $('.resource-item').toArray();
        
        items.sort(function(a, b) {
            const aTitle = $(a).data('title');
            const bTitle = $(b).data('title');
            const aIsRecommended = $(a).closest('#recommendedResources').length > 0;
            const bIsRecommended = $(b).closest('#recommendedResources').length > 0;
            
            switch(sortBy) {
                case 'recommended':
                    // 推荐优先，然后按标题排序
                    if (aIsRecommended && !bIsRecommended) return -1;
                    if (!aIsRecommended && bIsRecommended) return 1;
                    return aTitle.localeCompare(bTitle);
                    
                case 'newest':
                    // 按添加顺序（模拟）
                    return 0;
                    
                case 'title':
                    return aTitle.localeCompare(bTitle);
                    
                default:
                    return 0;
            }
        });
        
        $container.empty();
        items.forEach(item => {
            if ($(item).closest('#recommendedResources').length === 0) {
                $container.append(item);
            }
        });
        
        updateResourceCount();
    }
    
    // 分享资源表单
    $('#resourceDesc').on('input', function() {
        const length = $(this).val().length;
        $(this).next('.form-text').text(`${length}/200 字`);
        
        if (length > 200) {
            $(this).val($(this).val().substring(0, 200));
            $(this).next('.form-text').text('200/200 字').addClass('text-danger');
        } else {
            $(this).next('.form-text').removeClass('text-danger');
        }
    });
    
    $('#addResourceForm').submit(async function(e) {
        e.preventDefault();
        
        const title = $('#resourceTitle').val().trim();
        const url = $('#resourceUrl').val().trim();
        const type = $('#resourceType').val();
        
        if (!title) {
            showAlert('请输入资源标题', '提示');
            $('#resourceTitle').focus();
            return;
        }
        
        if (!url) {
            showAlert('请输入资源链接', '提示');
            $('#resourceUrl').focus();
            return;
        }
        
        if (!type) {
            showAlert('请选择资源类型', '提示');
            $('#resourceType').focus();
            return;
        }
        
        try {
            const $submitBtn = $('#submitResourceBtn');
            $submitBtn.prop('disabled', true).html('<i class="bi bi-hourglass-split me-1"></i>分享中...');
            
            // 模拟成功
            setTimeout(() => {
                showSuccess('资源分享成功！');
                $('#addResourceModal').modal('hide');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }, 800);
            
        } catch (error) {
            showError('分享失败，请重试');
            $('#submitResourceBtn').prop('disabled', false).html('分享资源');
        }
    });
    
    // 访问资源
    $('a[href*="http"]').click(function() {
        const url = $(this).attr('href');
        if (url && url.startsWith('http')) {
            console.log('访问资源:', url);
        }
    });
    
    // 页面加载后检查
    setTimeout(() => {
        if ($('#recommendedResources .resource-item').length === 0) {
            $('#recommendedResources').closest('.col-12').hide();
        }
    }, 500);
});
</script>
{% endblock %}
