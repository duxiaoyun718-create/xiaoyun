{% extends "base.html" %}

{% block title %}æ™ºèƒ½ä»ªè¡¨ç›˜ - CampusPulse{% endblock %}

{% block extra_css %}
<style>
    /* ä»ªè¡¨ç›˜ä¸“å±æ ·å¼ */
    .welcome-banner {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        border-radius: var(--radius);
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(99, 102, 241, 0.2);
        position: relative;
        overflow: hidden;
    }
    
    .welcome-banner::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
        border-radius: 50%;
    }
    
    .welcome-banner h1 {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    
    .resource-card {
        border-left: 4px solid var(--primary);
        transition: var(--transition);
    }
    
    .resource-card:hover {
        border-left-color: var(--secondary);
        transform: translateX(5px);
    }
    
    .mood-emoji {
        font-size: 2rem;
        margin-right: 1rem;
    }
    
    .health-tip-card {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(52, 211, 153, 0.1) 100%);
        border: 1px solid rgba(16, 185, 129, 0.2);
    }
    
    .timer-display {
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 3rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--dark) 0%, var(--gray) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: 2px;
    }
    
    .progress-ring {
        width: 80px;
        height: 80px;
    }
    
    .quick-action-btn {
        height: 120px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: 2px dashed var(--gray-light);
        background: white;
        transition: var(--transition);
    }
    
    .quick-action-btn:hover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.05);
        transform: translateY(-3px);
    }
    
    .quick-action-btn i {
        font-size: 2rem;
        margin-bottom: 0.75rem;
    }
    
    .urgent-task-alert {
        animation: pulse 2s infinite;
        border: 2px solid var(--danger);
    }
    
    @keyframes pulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    }
    
    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
        color: var(--gray);
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .ai-badge {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- æ¬¢è¿æ¨ªå¹… -->
    <div class="col-12">
        <div class="welcome-banner fade-in">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1>æ¬¢è¿å›æ¥ï¼Œ{{ username }}ï¼</h1>
                    <p class="text-muted mb-0">
                        <i class="bi bi-calendar3 me-2"></i><span id="currentDate">ä»Šå¤©</span>
                        <span class="mx-2">â€¢</span>
                        <i class="bi bi-clock me-2"></i><span id="currentTime">00:00</span>
                        <span class="mx-2">â€¢</span>
                        <i class="bi bi-stars me-2"></i>æ™ºèƒ½æ¨èç³»ç»Ÿå·²å°±ç»ª
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <span class="ai-badge">
                        <i class="bi bi-cpu me-1"></i>AIåŠ©æ‰‹åœ¨çº¿
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="col-xl-3 col-md-6 fade-in" style="animation-delay: 0.1s">
        <div class="stats-card" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-white-50 mb-1">æ€»ä»»åŠ¡æ•°</h6>
                    <h2 class="mb-0 text-white">{{ total_tasks }}</h2>
                    <small class="text-white-75">ç´¯è®¡åˆ›å»º</small>
                </div>
                <i class="bi bi-list-task text-white" style="font-size: 2.5rem; opacity: 0.8;"></i>
            </div>
            <div class="mt-3">
                <div class="progress bg-white-20" style="height: 4px;">
                    <div class="progress-bar bg-white" 
                         style="width: {{ (completed_tasks/total_tasks*100 if total_tasks > 0 else 0)|round }}%">
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-white-75">å®Œæˆç‡</small>
                    <small class="text-white">{{ (completed_tasks/total_tasks*100 if total_tasks > 0 else 0)|round }}%</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 fade-in" style="animation-delay: 0.2s">
        <div class="stats-card" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-white-50 mb-1">å·²å®Œæˆ</h6>
                    <h2 class="mb-0 text-white">{{ completed_tasks }}</h2>
                    <small class="text-white-75">å·²å®Œæˆä»»åŠ¡</small>
                </div>
                <i class="bi bi-check-circle text-white" style="font-size: 2.5rem; opacity: 0.8;"></i>
            </div>
            <div class="mt-3">
                <div class="progress bg-white-20" style="height: 4px;">
                    <div class="progress-bar bg-white" 
                         style="width: {{ (completed_tasks/total_tasks*100 if total_tasks > 0 else 0)|round }}%">
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-white-75">ä»Šæ—¥å®Œæˆ</small>
                    <small class="text-white">0</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 fade-in" style="animation-delay: 0.3s">
        <div class="stats-card" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-white-50 mb-1">è¿›è¡Œä¸­</h6>
                    <h2 class="mb-0 text-white">{{ total_tasks - completed_tasks }}</h2>
                    <small class="text-white-75">å¾…å®Œæˆä»»åŠ¡</small>
                </div>
                <i class="bi bi-clock text-white" style="font-size: 2.5rem; opacity: 0.8;"></i>
            </div>
            <div class="mt-3">
                <div class="progress bg-white-20" style="height: 4px;">
                    <div class="progress-bar bg-white" 
                         style="width: {{ ((total_tasks - completed_tasks)/total_tasks*100 if total_tasks > 0 else 0)|round }}%">
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-white-75">å‰©ä½™ä»»åŠ¡</small>
                    <small class="text-white">{{ total_tasks - completed_tasks }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 fade-in" style="animation-delay: 0.4s">
        <div class="stats-card" style="background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-white-50 mb-1">ä»Šæ—¥å¿ƒæƒ…</h6>
                    <h2 class="mb-0 text-white">
                        {% if recent_mood %}
                            {{ recent_mood.mood_score }}/5
                        {% else %}
                            æœªè®°å½•
                        {% endif %}
                    </h2>
                    <small class="text-white-75">
                        {% if recent_mood %}
                            {{ ['éœ€å…³æ³¨', 'ä¸€èˆ¬', 'æ™®é€š', 'è‰¯å¥½', 'ä¼˜ç§€'][recent_mood.mood_score - 1] }}
                        {% else %}
                            ç‚¹å‡»è®°å½•å¿ƒæƒ…
                        {% endif %}
                    </small>
                </div>
                <div class="mood-emoji">
                    {% if recent_mood %}
                        {{ ['ğŸ˜', 'ğŸ˜•', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š'][recent_mood.mood_score - 1] }}
                    {% else %}
                        ğŸ˜¶
                    {% endif %}
                </div>
            </div>
            <div class="mt-3">
                <a href="{{ url_for('mood') }}" class="btn btn-sm btn-light w-100 hover-lift">
                    <i class="bi bi-plus-circle me-1"></i> 
                    {% if recent_mood %}æ›´æ–°å¿ƒæƒ…{% else %}è®°å½•å¿ƒæƒ…{% endif %}
                </a>
            </div>
        </div>
    </div>

    <!-- æ™ºèƒ½æ¨èåŒºåŸŸ -->
    <div class="col-lg-8 fade-in" style="animation-delay: 0.5s">
        <div class="row g-4">
            <!-- å­¦ä¹ èµ„æºæ¨è -->
            <div class="col-12">
                <div class="card hover-lift">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-1">
                                    <i class="bi bi-stars text-primary me-2"></i>æ™ºèƒ½å­¦ä¹ èµ„æºæ¨è
                                </h5>
                                <p class="text-muted small mb-0">åŸºäºä½ çš„ä»»åŠ¡å†…å®¹åˆ†ææ¨è</p>
                            </div>
                            <span class="ai-badge">
                                <i class="bi bi-robot me-1"></i>AIé©±åŠ¨
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if learning_resources %}
                        <div class="row g-3">
                            {% for resource in learning_resources %}
                            <div class="col-md-6">
                                <div class="card resource-card hover-lift">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">{{ resource.title }}</h6>
                                            <span class="badge bg-primary-soft">{{ resource.resource_type }}</span>
                                        </div>
                                        <p class="card-text small text-muted mb-3">
                                            {{ resource.description|default('æš‚æ— æè¿°', true) }}
                                        </p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <a href="{{ resource.url }}" target="_blank" 
                                               class="btn btn-sm btn-outline-primary hover-lift">
                                                <i class="bi bi-box-arrow-up-right me-1"></i>è®¿é—®èµ„æº
                                            </a>
                                            {% if resource.keywords %}
                                            <small class="text-muted">
                                                <i class="bi bi-tag me-1"></i>{{ resource.keywords.split(',')[0]|trim }}
                                            </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-book"></i>
                            <h6 class="mt-3">æš‚æ— æ¨èèµ„æº</h6>
                            <p class="text-muted small">æ·»åŠ ä¸€äº›å­¦ä¹ ä»»åŠ¡ï¼Œç³»ç»Ÿä¼šä¸ºä½ æ¨èç›¸å…³èµ„æº</p>
                            <a href="{{ url_for('tasks') }}" class="btn btn-primary btn-sm mt-2 hover-lift">
                                <i class="bi bi-plus-circle me-1"></i>å»æ·»åŠ ä»»åŠ¡
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- å¥åº·å»ºè®®å’Œç´§æ€¥ä»»åŠ¡ -->
            <div class="col-md-6">
                <div class="card health-tip-card hover-lift">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-heart-pulse text-success me-2"></i>ä¸ªæ€§åŒ–å¥åº·å»ºè®®
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if health_tips %}
                        <div class="list-group list-group-flush">
                            {% for tip in health_tips %}
                            <div class="list-group-item bg-transparent px-0">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0">
                                        <i class="bi bi-lightbulb text-warning fs-5"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <p class="mb-0">{{ tip }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-3">
                            <i class="bi bi-emoji-smile fs-1 text-muted"></i>
                            <p class="text-muted small mt-2">è®°å½•å¿ƒæƒ…åè·å–ä¸ªæ€§åŒ–å»ºè®®</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                {% if urgent_tasks %}
                <div class="card urgent-task-alert hover-lift">
                    <div class="card-header bg-white border-0">
                        <h5 class="card-title mb-0 text-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>ç´§æ€¥ä»»åŠ¡æé†’
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for task in urgent_tasks %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">{{ task.title }}</h6>
                                        {% if task.due_date %}
                                        <small class="text-danger">
                                            <i class="bi bi-clock me-1"></i>
                                            æˆªæ­¢: {{ task.due_date.strftime('%mæœˆ%dæ—¥ %H:%M') }}
                                        </small>
                                        {% endif %}
                                    </div>
                                    <a href="{{ url_for('tasks') }}" class="btn btn-danger btn-sm hover-lift">
                                        <i class="bi bi-arrow-right"></i>
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card hover-lift">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-check2-circle text-success me-2"></i>ä»»åŠ¡çŠ¶æ€è‰¯å¥½
                        </h5>
                    </div>
                    <div class="card-body text-center py-4">
                        <i class="bi bi-emoji-smile text-success fs-1"></i>
                        <p class="text-muted small mt-2">æš‚æ— ç´§æ€¥ä»»åŠ¡</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ä¾§è¾¹æ ï¼šå¿«é€Ÿæ“ä½œå’Œå­¦ä¹ è®¡æ—¶å™¨ -->
    <div class="col-lg-4 fade-in" style="animation-delay: 0.6s">
        <div class="sticky-top" style="top: 100px;">
            <!-- å­¦ä¹ è®¡æ—¶å™¨ -->
            <div class="card mb-4 hover-lift">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history text-primary me-2"></i>å­¦ä¹ è®¡æ—¶å™¨
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="timer-display mb-3" id="timerDisplay">25:00</div>
                    <div class="mb-3">
                        <span class="badge bg-primary-soft me-2" id="timerMode">ä¸“æ³¨æ—¶é—´</span>
                        <span class="badge bg-success-soft" id="timerStatus">å‡†å¤‡å°±ç»ª</span>
                    </div>
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-success hover-lift" id="startTimerBtn">
                            <i class="bi bi-play-circle me-1"></i>å¼€å§‹
                        </button>
                        <button type="button" class="btn btn-warning hover-lift" id="pauseTimerBtn" disabled>
                            <i class="bi bi-pause-circle me-1"></i>æš‚åœ
                        </button>
                        <button type="button" class="btn btn-danger hover-lift" id="stopTimerBtn" disabled>
                            <i class="bi bi-stop-circle me-1"></i>åœæ­¢
                        </button>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>ç•ªèŒ„å·¥ä½œæ³•ï¼š25åˆ†é’Ÿä¸“æ³¨ + 5åˆ†é’Ÿä¼‘æ¯
                        </small>
                    </div>
                </div>
            </div>

            <!-- å¿«é€Ÿæ“ä½œ -->
            <div class="card hover-lift">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning text-warning me-2"></i>å¿«é€Ÿæ“ä½œ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <a href="{{ url_for('tasks') }}" class="card quick-action-btn text-decoration-none hover-lift">
                                <i class="bi bi-plus-circle text-primary"></i>
                                <span class="fw-semibold">æ·»åŠ ä»»åŠ¡</span>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{{ url_for('mood') }}" class="card quick-action-btn text-decoration-none hover-lift">
                                <i class="bi bi-emoji-smile text-success"></i>
                                <span class="fw-semibold">è®°å½•å¿ƒæƒ…</span>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{{ url_for('resources') }}" class="card quick-action-btn text-decoration-none hover-lift">
                                <i class="bi bi-search text-info"></i>
                                <span class="fw-semibold">å­¦ä¹ èµ„æº</span>
                            </a>
                        </div>
                        <div class="col-6">
                            <button class="card quick-action-btn border-0 w-100 hover-lift" id="quickNoteBtn">
                                <i class="bi bi-pencil text-warning"></i>
                                <span class="fw-semibold">å¿«é€Ÿç¬”è®°</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç³»ç»ŸçŠ¶æ€ -->
            <div class="card mt-4 hover-lift">
                <div class="card-body">
                    <h6 class="mb-3">
                        <i class="bi bi-graph-up text-primary me-2"></i>ç³»ç»ŸçŠ¶æ€
                    </h6>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">å­¦ä¹ æ•ˆç‡</span>
                        <span class="fw-semibold">{{ (completed_tasks/total_tasks*100 if total_tasks > 0 else 0)|round }}%</span>
                    </div>
                    <div class="progress mb-3" style="height: 6px;">
                        <div class="progress-bar bg-primary" 
                             style="width: {{ (completed_tasks/total_tasks*100 if total_tasks > 0 else 0)|round }}%">
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">å¿ƒæƒ…æŒ‡æ•°</span>
                        <span class="fw-semibold">
                            {% if recent_mood %}
                                {{ recent_mood.mood_score }}/5
                            {% else %}
                                --
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¿«é€Ÿç¬”è®°æ¨¡æ€æ¡† -->
<div class="modal fade" id="quickNoteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil me-2"></i>å¿«é€Ÿç¬”è®°
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" rows="5" placeholder="è®°å½•ä½ çš„æƒ³æ³•ã€çµæ„Ÿæˆ–å¾…åŠäº‹é¡¹..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary hover-lift" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary hover-lift">ä¿å­˜ç¬”è®°</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // åŠ¨æ€æ˜¾ç¤ºæœ¬åœ°æ—¶é—´
function updateLocalDateTime() {
    const now = new Date();
    
    // æ ¼å¼åŒ–æ—¥æœŸï¼š2024å¹´12æœˆ29æ—¥
    const dateStr = now.getFullYear() + 'å¹´' + 
                   (now.getMonth() + 1).toString().padStart(2, '0') + 'æœˆ' + 
                   now.getDate().toString().padStart(2, '0') + 'æ—¥';
    
    // æ ¼å¼åŒ–æ—¶é—´ï¼š14:30
    const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
    
    // æ˜ŸæœŸå‡ 
    const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    const weekday = weekdays[now.getDay()];
    
    // æ›´æ–°æ˜¾ç¤º
    document.getElementById('currentDate').textContent = dateStr + ' ' + weekday;
    document.getElementById('currentTime').textContent = timeStr;
}

// é¡µé¢åŠ è½½æ—¶ç«‹å³æ›´æ–°
updateLocalDateTime();

// æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´
setInterval(updateLocalDateTime, 60000);

// æ¯ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´ï¼ˆæ›´ç²¾ç¡®ï¼‰
setInterval(() => {
    const now = new Date();
    const seconds = now.getSeconds();
    if (seconds === 0) {
        updateLocalDateTime();
    }
}, 1000);
$(document).ready(function() {
    // å­¦ä¹ è®¡æ—¶å™¨åŠŸèƒ½
    let timerInterval;
    let totalSeconds = 25 * 60; // 25åˆ†é’Ÿ
    let isWorking = true;
    let isRunning = false;
    
    const startBtn = $('#startTimerBtn');
    const pauseBtn = $('#pauseTimerBtn');
    const stopBtn = $('#stopTimerBtn');
    const timerDisplay = $('#timerDisplay');
    const timerMode = $('#timerMode');
    const timerStatus = $('#timerStatus');
    
    function updateDisplay() {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        timerDisplay.text(`${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);
    }
    
    startBtn.click(function() {
        if (!isRunning) {
            isRunning = true;
            startBtn.prop('disabled', true);
            pauseBtn.prop('disabled', false);
            stopBtn.prop('disabled', false);
            timerStatus.text('è¿›è¡Œä¸­').removeClass('bg-success-soft').addClass('bg-warning-soft');
            
            timerInterval = setInterval(function() {
                totalSeconds--;
                updateDisplay();
                
                if (totalSeconds <= 0) {
                    clearInterval(timerInterval);
                    if (isWorking) {
                        // å·¥ä½œç»“æŸï¼Œå¼€å§‹ä¼‘æ¯
                        showNotification('ä¸“æ³¨æ—¶é—´ç»“æŸï¼ä¼‘æ¯5åˆ†é’Ÿ', 'info');
                        totalSeconds = 5 * 60; // 5åˆ†é’Ÿä¼‘æ¯
                        isWorking = false;
                        timerMode.text('ä¼‘æ¯æ—¶é—´').removeClass('bg-primary-soft').addClass('bg-success-soft');
                        timerStatus.text('ä¼‘æ¯ä¸­');
                        startTimer(); // å¼€å§‹ä¼‘æ¯è®¡æ—¶
                    } else {
                        // ä¼‘æ¯ç»“æŸ
                        showNotification('ä¼‘æ¯æ—¶é—´ç»“æŸï¼å¼€å§‹æ–°çš„ä¸“æ³¨å‘¨æœŸ', 'success');
                        resetTimer();
                    }
                }
            }, 1000);
        }
    });
    
    pauseBtn.click(function() {
        if (isRunning) {
            clearInterval(timerInterval);
            isRunning = false;
            startBtn.prop('disabled', false);
            pauseBtn.prop('disabled', true);
            timerStatus.text('å·²æš‚åœ').removeClass('bg-warning-soft').addClass('bg-danger-soft');
        }
    });
    
    stopBtn.click(function() {
        clearInterval(timerInterval);
        resetTimer();
        showNotification('è®¡æ—¶å™¨å·²åœæ­¢', 'info');
    });
    
    function resetTimer() {
        isRunning = false;
        isWorking = true;
        totalSeconds = 25 * 60;
        updateDisplay();
        startBtn.prop('disabled', false);
        pauseBtn.prop('disabled', true);
        stopBtn.prop('disabled', true);
        timerMode.text('ä¸“æ³¨æ—¶é—´').removeClass('bg-success-soft').addClass('bg-primary-soft');
        timerStatus.text('å‡†å¤‡å°±ç»ª').removeClass('bg-danger-soft bg-warning-soft').addClass('bg-success-soft');
    }
    
    function startTimer() {
        isRunning = true;
        timerInterval = setInterval(function() {
            totalSeconds--;
            updateDisplay();
            
            if (totalSeconds <= 0) {
                clearInterval(timerInterval);
                if (!isWorking) {
                    // ä¼‘æ¯ç»“æŸ
                    showNotification('ä¼‘æ¯æ—¶é—´ç»“æŸï¼å¼€å§‹æ–°çš„ä¸“æ³¨å‘¨æœŸ', 'success');
                    resetTimer();
                }
            }
        }, 1000);
    }
    
    // å¿«é€Ÿç¬”è®°åŠŸèƒ½
    $('#quickNoteBtn').click(function() {
        $('#quickNoteModal').modal('show');
    });
    
    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'info') {
        if (type === 'info') {
            showToast(message, 'info');
        } else if (type === 'success') {
            showToast(message, 'success');
        }
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä»Šæ—¥å¿ƒæƒ…è®°å½•
    {% if not recent_mood %}
    setTimeout(function() {
        if (confirm('ä½ è¿˜æ²¡æœ‰è®°å½•ä»Šæ—¥å¿ƒæƒ…ï¼Œç°åœ¨å»è®°å½•å—ï¼Ÿ')) {
            window.location.href = "{{ url_for('mood') }}";
        }
    }, 3000);
    {% endif %}
    
    // åˆå§‹åŒ–æ˜¾ç¤º
    updateDisplay();
});
</script>
{% endblock %}